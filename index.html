<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Martingale V2 â€” BottomUP</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}html,body,#root{height:100%;width:100%}
body{background:#13151C;color:#F3F4F6;font-family:'DM Sans',system-ui,sans-serif}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#13151C}::-webkit-scrollbar-thumb{background:#2A2D3A;border-radius:3px}
input[type=range]{-webkit-appearance:none;background:rgba(123,92,245,0.15);border-radius:3px;outline:none;height:4px;width:100%}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#7B5CF5;cursor:pointer;box-shadow:0 0 8px rgba(123,92,245,0.4)}
select{background:#1A1D26;color:#F3F4F6;border:1px solid rgba(123,92,245,0.2);border-radius:8px;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;outline:none;cursor:pointer}select:focus{border-color:#7B5CF5}
textarea{background:#0D0E14;color:#F3F4F6;border:1px solid rgba(123,92,245,0.2);border-radius:10px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;outline:none;resize:vertical;width:100%}textarea:focus{border-color:#7B5CF5}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.tip{position:relative;cursor:help;display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:rgba(123,92,245,0.15);color:#7B5CF5;font-size:9px;font-weight:700;margin-left:4px;flex-shrink:0}.tip:hover .tiptext{display:block}
.tiptext{display:none;position:absolute;bottom:22px;left:50%;transform:translateX(-50%);background:#1E2130;border:1px solid rgba(123,92,245,0.25);border-radius:8px;padding:8px 10px;font-family:'DM Sans';font-size:11px;color:#F3F4F6;width:220px;z-index:999;line-height:1.4;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef}=React;const LWC=window.LightweightCharts;
const P={violet:"#7B5CF5",ember:"#F97316",jade:"#2DC771",danger:"#EF4444",cobalt:"#3B5BF5",ink:"#13151C",ash:"#6B7280",mist:"#F3F4F6",white:"#FFFFFF",card:"#1A1D26",surface:"#1E2130",border:"rgba(123,92,245,0.12)"};
const Fd="'Cormorant Display',Georgia,serif",Fs="'DM Sans',system-ui,sans-serif",Fm="'JetBrains Mono',monospace";
const LOGO="data:image/jpeg;base64,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";
const DN={"GC=F":"AltÄ±n","SI=F":"GÃ¼mÃ¼ÅŸ","CL=F":"Petrol","NG=F":"DoÄŸalgaz","HG=F":"BakÄ±r","PL=F":"Platin","PA=F":"Paladyum","ZC=F":"MÄ±sÄ±r","ZW=F":"BuÄŸday","ZS=F":"Soya","KC=F":"Kahve","CC=F":"Kakao","SB=F":"Åeker","CT=F":"Pamuk","ALI=F":"AlÃ¼minyum","EURUSD=X":"EUR/USD","GBPUSD=X":"GBP/USD","USDJPY=X":"USD/JPY","USDTRY=X":"USD/TRY"};
const dN=s=>DN[s]||s.replace("-USDT","/USDT").replace("USDT","/USDT");

async function fetchOKX(instId,bar,limit){const r=await fetch(`/api/okx/candles/${encodeURIComponent(instId)}?bar=${bar}&limit=${limit||300}`);if(!r.ok)throw new Error("OKX "+r.status);return(await r.json()).candles||[];}
async function fetchYahoo(sym,interval,range){const r=await fetch(`/api/yahoo/${encodeURIComponent(sym)}?interval=${interval}&range=${range}`);if(!r.ok)throw new Error((await r.json().catch(()=>({}))).error||`Yahoo ${r.status}`);return(await r.json()).candles||[];}
async function fetchData(mkt,sym,tfObj){return mkt==="crypto"?fetchOKX(sym,tfObj.value,tfObj.limit||300):fetchYahoo(sym,tfObj.value,tfObj.range||"1y");}

function _atr(b,x,len){if(x<1)return b[0].high-b[0].low;let s=0,n=0;for(let i=Math.max(1,x-len+1);i<=x;i++){s+=Math.max(b[i].high-b[i].low,Math.abs(b[i].high-b[i-1].close),Math.abs(b[i].low-b[i-1].close));n++;}return n?s/n:0;}
function _ema(b,x,len){const k=2/(len+1);let e=b[0].close;for(let i=1;i<=x;i++)e=b[i].close*k+e*(1-k);return e;}
function _rsi(b,x,len=14){if(x<len)return 50;let g=0,lo=0;for(let i=x-len+1;i<=x;i++){const d=b[i].close-b[i-1].close;if(d>0)g+=d;else lo-=d;}return lo===0?100:100-100/(1+g/lo);}
function backtest(bars,cfg){const{al,man,mA,mP,aL,pD,rOn,rV,eOn,eL,cap}=cfg;const I=cap||10000;let cash=I,pos=[],trades=[],eqData=[],entries=[],exits=[];let peak=I,mDD=0;for(let i=1;i<bars.length;i++){const p=bars[i].close,a=_atr(bars,i,aL),e10=_ema(bars,i,eL||10),r=_rsi(bars,i);const fA=man?mA:a,fT=man?mP:a/pD,eS=eOn?p<e10:true,rO=rOn?r<rV:true;const pV=pos.reduce((s,x)=>s+x.q*p,0),curE=cash+pV;if(!pos.length&&eS&&rO){const amt=curE*(al[0]/100);if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:1});}}else if(pos.length>0&&pos.length<5){const lE=pos[pos.length-1].ep;if(p<lE-fA&&eS){const e2=cash+pos.reduce((s,x)=>s+x.q*p,0),amt=e2*(al[pos.length]/100);if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:pos.length});}}}if(pos.length>0){const tQ=pos.reduce((s,x)=>s+x.q,0),tC=pos.reduce((s,x)=>s+x.q*x.ep,0),aP=tC/tQ,rE=rOn&&r>rV;if(p>=aP+fT||rE){const eV=tQ*p,pnl=eV-tC;trades.push({bar:i,time:bars[i].time,ae:+aP.toFixed(2),ex:+p.toFixed(2),ly:pos.length,pnl:+pnl.toFixed(2),pp:+((pnl/tC)*100).toFixed(2),rs:rE?"RSI":"TP",at:+fA.toFixed(2)});exits.push({time:bars[i].time,price:p,reason:rE?"RSI":"TP",pnl:+pnl.toFixed(2)});cash+=eV;pos=[];}}const cE=cash+pos.reduce((s,x)=>s+x.q*p,0);if(cE>peak)peak=cE;const dd=((peak-cE)/peak)*100;if(dd>mDD)mDD=dd;eqData.push({time:bars[i].time,value:+cE.toFixed(2)});}const fE=cash+pos.reduce((s,x)=>s+x.q*bars[bars.length-1].close,0);const w=trades.filter(t=>t.pnl>0),lo=trades.filter(t=>t.pnl<=0);const gW=w.reduce((s,t)=>s+t.pnl,0),gL=Math.abs(lo.reduce((s,t)=>s+t.pnl,0));return{trades,eqData,entries,exits,s:{fE:+fE.toFixed(2),ret:+(((fE-I)/I)*100).toFixed(2),cnt:trades.length,wr:trades.length?+((w.length/trades.length)*100).toFixed(1):0,mDD:+mDD.toFixed(2),pf:gL>0?+(gW/gL).toFixed(2):w.length?999:0,aW:w.length?+(gW/w.length).toFixed(2):0,aL:lo.length?+(-gL/lo.length).toFixed(2):0,aLy:trades.length?+(trades.reduce((s,t)=>s+t.ly,0)/trades.length).toFixed(1):0,oL:pos.length,best:trades.length?+Math.max(...trades.map(t=>t.pnl)).toFixed(2):0,worst:trades.length?+Math.min(...trades.map(t=>t.pnl)).toFixed(2):0}};}
function parsePine(code){const r={};for(const line of code.split('\n')){const m=line.trim().match(/(\w+)\s*=\s*input[\w.]*\(([^)]+)\)/);if(m){const v=m[1].toLowerCase(),a=m[2],n=s=>{const x=s.match(/-?[\d.]+/);return x?parseFloat(x[0]):null;},dv=n(a);if(v.includes('pos1')||v.includes('alloc'))r.layer1=dv;if(v.includes('pos2'))r.layer2=dv;if(v.includes('pos3'))r.layer3=dv;if(v.includes('pos4'))r.layer4=dv;if(v.includes('pos5'))r.layer5=dv;if(v.includes('aptr')||v.includes('drop'))r.aptr=dv;if(v.includes('profit')||v.includes('target'))r.profitTarget=dv;if(v.includes('atr_len'))r.atrLength=dv;if(v.includes('rsi_level'))r.rsiLevel=dv;if(v.includes('use_ema'))r.useEma=line.includes('true');if(v.includes('use_rsi'))r.useRsi=line.includes('true');if(v.includes('manual'))r.useManual=line.includes('true');}}return r;}
function mergeCfg(cur,parsed){const n=JSON.parse(JSON.stringify(cur));const d=n.defaults,a=n.allocations;['useManual','useEma','useRsi'].forEach(k=>{if(parsed[k]!==undefined)d[k]=parsed[k];});['rsiLevel','atrLength','emaLength','profitDivisor'].forEach(k=>{if(parsed[k])d[k]=parsed[k];});['layer1','layer2','layer3','layer4','layer5'].forEach(k=>{if(parsed[k])a[k]=parsed[k];});n._version=(parseFloat(n._version||"3.0")+0.1).toFixed(1);return n;}

function TVChart({bars,entries,exits,eqData,tab}){const ref=useRef(null),cr=useRef(null);useEffect(()=>{if(!ref.current||!LWC)return;if(cr.current)try{cr.current.remove()}catch(e){}ref.current.innerHTML='';const ch=LWC.createChart(ref.current,{width:ref.current.clientWidth,height:400,layout:{background:{type:'solid',color:P.card},textColor:P.ash,fontFamily:Fm,fontSize:11},grid:{vertLines:{color:'rgba(123,92,245,0.06)'},horzLines:{color:'rgba(123,92,245,0.06)'}},crosshair:{mode:0},rightPriceScale:{borderColor:P.border},timeScale:{borderColor:P.border,timeVisible:true},handleScroll:true,handleScale:true});cr.current=ch;if(tab==="candles"&&bars?.length){const cs=ch.addCandlestickSeries({upColor:P.jade,downColor:P.danger,borderUpColor:P.jade,borderDownColor:P.danger,wickUpColor:P.jade+'99',wickDownColor:P.danger+'99'});cs.setData(bars);const vs=ch.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:'vol'});ch.priceScale('vol').applyOptions({scaleMargins:{top:0.85,bottom:0}});vs.setData(bars.map(b=>({time:b.time,value:b.volume,color:b.close>=b.open?P.jade+'33':P.danger+'33'})));if(entries?.length||exits?.length){cs.setMarkers([...(entries||[]).map(e=>({time:e.time,position:'belowBar',color:P.jade,shape:'arrowUp',text:'B'+e.layer})),...(exits||[]).map(x=>({time:x.time,position:'aboveBar',color:x.pnl>=0?P.jade:P.danger,shape:'arrowDown',text:x.reason+(x.pnl>=0?' +':' ')+x.pnl.toFixed(0)}))].sort((a,b)=>a.time-b.time));}}if(tab==="equity"&&eqData?.length){ch.addAreaSeries({topColor:P.violet+'33',bottomColor:P.violet+'05',lineColor:P.violet,lineWidth:2}).setData(eqData);}if(tab==="drawdown"&&eqData?.length){let pk=10000;ch.addAreaSeries({topColor:P.danger+'33',bottomColor:P.danger+'05',lineColor:P.danger,lineWidth:2,invertFilledArea:true}).setData(eqData.map(d=>{if(d.value>pk)pk=d.value;return{time:d.time,value:+((pk-d.value)/pk*100).toFixed(2)};}));}ch.timeScale().fitContent();const ro=new ResizeObserver(()=>{if(ref.current)ch.applyOptions({width:ref.current.clientWidth})});ro.observe(ref.current);return()=>{ro.disconnect();try{ch.remove()}catch(e){}};},[bars,entries,exits,eqData,tab]);return <div ref={ref} style={{width:"100%",borderRadius:12,overflow:"hidden"}}/>;}

const Tip=({text})=><span className="tip">?<span className="tiptext">{text}</span></span>;
const Stat=({l,v,color,pre="",suf="",tip})=><div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:12,padding:"11px 13px",flex:"1 1 110px",minWidth:100,animation:"fadeIn 0.3s"}}><div style={{fontFamily:Fm,fontSize:9,color:P.ash,letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:5,display:"flex",alignItems:"center"}}>{l}{tip&&<Tip text={tip}/>}</div><div style={{fontFamily:Fm,fontSize:15,fontWeight:600,color:color||P.mist}}>{pre}{typeof v==="number"?v.toLocaleString("en",{maximumFractionDigits:2}):v}{suf}</div></div>;
const Sld=({l,v,set,min,max,step=1,suf="",tip})=><div style={{marginBottom:9}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:2}}><span style={{fontFamily:Fs,fontSize:11,color:P.ash,display:"flex",alignItems:"center"}}>{l}{tip&&<Tip text={tip}/>}</span><span style={{fontFamily:Fm,fontSize:11,color:P.violet,fontWeight:600}}>{v}{suf}</span></div><input type="range" min={min} max={max} step={step} value={v} onChange={e=>set(+e.target.value)}/></div>;
const Tog=({l,v,set,tip})=><label style={{display:"flex",alignItems:"center",gap:8,fontFamily:Fs,fontSize:11,color:P.ash,marginBottom:7,cursor:"pointer"}}><div onClick={()=>set(!v)} style={{width:36,height:20,borderRadius:10,background:v?P.violet:"#2A2D3A",position:"relative",flexShrink:0,transition:"0.25s"}}><div style={{width:16,height:16,borderRadius:8,background:P.white,position:"absolute",top:2,left:v?18:2,transition:"0.25s"}}/></div>{l}{tip&&<Tip text={tip}/>}</label>;

function Onboarding({onClose}){const[step,setStep]=useState(0);const steps=[{t:"HoÅŸ geldiniz! ğŸ‘‹",b:"Martingale V2 stratejisini kripto, ABD hisseleri ve emtialar Ã¼zerinde test edin.",i:"ğŸ¯"},{t:"Strateji",b:"Fiyat dÃ¼ÅŸtÃ¼kÃ§e kademe kademe alÄ±m yapar (5 katman). Ortalama giriÅŸin Ã¼zerine Ã§Ä±kÄ±nca kÃ¢rla kapatÄ±r.",i:"ğŸ“Š"},{t:"Ayarlar",b:"â€¢ Allocation: Katman yÃ¼zdeleri (%100)\nâ€¢ APTR: Katmanlar arasÄ± $ farkÄ±\nâ€¢ Profit Target: KÃ¢r hedefi\nâ€¢ EMA/RSI: Filtreler",i:"âš™ï¸"},{t:"Multi-Market",b:"ğŸª™ Kripto: BTC, ETH, SOL... (OKX)\nğŸ“ˆ Hisse: AAPL, NVDA, TSLA... (Yahoo)\nğŸ—ï¸ Emtia: AltÄ±n, Petrol, BuÄŸday...",i:"ğŸŒ"},{t:"Pine Script Konsol",b:"</> butonuyla Pine Script kodunuzu yapÄ±ÅŸtÄ±rÄ±n. Parametreler otomatik gÃ¼ncellenir. Geri Al ile Ã¶nceki versiyona dÃ¶nÃ¼n.",i:"ğŸ’»"}];const s=steps[step];
return <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeIn 0.3s"}}><div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:20,padding:32,maxWidth:480,width:"90%",animation:"slideUp 0.4s"}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}><img src={LOGO} width="28" height="28" style={{borderRadius:6}}/><span style={{fontFamily:Fs,fontSize:13,color:P.ash}}>BottomUP</span><span style={{marginLeft:"auto",fontFamily:Fm,fontSize:10,color:P.ash}}>{step+1}/{steps.length}</span></div><div style={{fontSize:36,marginBottom:12}}>{s.i}</div><h2 style={{fontFamily:Fd,fontSize:24,color:P.white,marginBottom:10}}>{s.t}</h2><p style={{fontFamily:Fs,fontSize:13,color:P.mist,lineHeight:1.7,whiteSpace:"pre-line",marginBottom:20}}>{s.b}</p><div style={{display:"flex",gap:8,justifyContent:"space-between"}}><button onClick={onClose} style={{fontFamily:Fs,fontSize:12,padding:"8px 16px",borderRadius:8,background:"transparent",border:`1px solid ${P.border}`,color:P.ash,cursor:"pointer"}}>Atla</button><div style={{display:"flex",gap:6}}>{step>0&&<button onClick={()=>setStep(step-1)} style={{fontFamily:Fs,fontSize:12,padding:"8px 16px",borderRadius:8,background:P.surface,border:"none",color:P.mist,cursor:"pointer"}}>â†</button>}{step<steps.length-1?<button onClick={()=>setStep(step+1)} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:P.violet,border:"none",color:P.white,cursor:"pointer"}}>Ä°leri â†’</button>:<button onClick={onClose} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:P.jade,border:"none",color:P.white,cursor:"pointer"}}>BaÅŸla! ğŸš€</button>}</div></div></div></div>;}

function DevConsole({open,onClose,cfg,onApply}){const[code,setCode]=useState('');const[parsed,setParsed]=useState(null);const[err,setErr]=useState(null);const[saving,setSaving]=useState(false);const[saved,setSaved]=useState(false);const[hist,setHist]=useState([]);const[rb,setRb]=useState(false);
useEffect(()=>{if(open)fetch('/api/strategy/history').then(r=>r.json()).then(setHist).catch(()=>{});},[open]);
if(!open)return null;
return <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:9998,display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeIn 0.2s"}}><div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:16,width:"90%",maxWidth:700,maxHeight:"90vh",overflow:"hidden",display:"flex",flexDirection:"column",animation:"slideUp 0.3s"}}>
<div style={{padding:"16px 20px",borderBottom:`1px solid ${P.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><div style={{display:"flex",alignItems:"center",gap:10}}><span style={{fontSize:18}}>ğŸ§‘â€ğŸ’»</span><div><h2 style={{fontFamily:Fd,fontSize:20,color:P.white}}>Pine Script <span style={{color:P.violet}}>Konsol</span></h2><p style={{fontFamily:Fm,fontSize:9,color:P.ash}}>YapÄ±ÅŸtÄ±r â†’ Parse â†’ Uygula</p></div></div><button onClick={onClose} style={{fontSize:18,background:"transparent",border:"none",color:P.ash,cursor:"pointer"}}>âœ•</button></div>
<div style={{padding:20,overflowY:"auto",flex:1}}>
<label style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.1em",textTransform:"uppercase",display:"block",marginBottom:6}}>Pine Script Kodu</label>
<textarea value={code} onChange={e=>setCode(e.target.value)} rows={8} placeholder={"// Pine Script kodunu yapÄ±ÅŸtÄ±rÄ±n\npos1_alloc = input.float(10, \"Pos 1 %\")\naptr = input.float(80, \"APTR $\")"}/>
<div style={{display:"flex",gap:8,marginTop:8}}>
<button onClick={()=>{setErr(null);setSaved(false);const p=parsePine(code);if(!Object.keys(p).length){setErr("âš  Parametre bulunamadÄ±.");return;}setParsed(p);}} disabled={!code.trim()} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:code.trim()?P.violet:P.surface,border:"none",color:P.white,cursor:code.trim()?"pointer":"not-allowed"}}>ğŸ” Parse Et</button>
{parsed&&<button onClick={async()=>{if(!parsed||!cfg)return;setSaving(true);try{const merged=mergeCfg(cfg,parsed);const r=await fetch('/api/strategy',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(merged)});if(!r.ok)throw new Error('Fail');setSaved(true);setParsed(null);setCode('');onApply(merged);setHist(await(await fetch('/api/strategy/history')).json());}catch(e){setErr("Hata: "+e.message);}setSaving(false);}} disabled={saving} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:saving?P.surface:P.jade,border:"none",color:P.white,cursor:saving?"wait":"pointer"}}>{saving?"â³":"âœ… Uygula"}</button>}
</div>
{err&&<div style={{padding:"10px",background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.25)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.danger,marginTop:10}}>{err}</div>}
{saved&&<div style={{padding:"10px",background:"rgba(45,199,113,0.1)",border:"1px solid rgba(45,199,113,0.25)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.jade,marginTop:10}}>âœ… GÃ¼ncellendi! RUN basÄ±n.</div>}
{parsed&&!saved&&<div style={{background:P.surface,borderRadius:10,padding:14,marginTop:12,border:`1px solid ${P.border}`}}><div style={{fontFamily:Fm,fontSize:10,color:P.ember,marginBottom:8,fontWeight:600}}>ğŸ“‹ PARSE SONUÃ‡LARI</div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,fontFamily:Fm,fontSize:12}}>{Object.entries(parsed).map(([k,v])=><div key={k} style={{display:"flex",justifyContent:"space-between",padding:"4px 8px",background:P.card,borderRadius:6}}><span style={{color:P.ash}}>{k}</span><span style={{color:P.violet,fontWeight:600}}>{String(v)}</span></div>)}</div></div>}
<div style={{borderTop:`1px solid ${P.border}`,paddingTop:14,marginTop:16}}><div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.1em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>ğŸ“¦ Versiyon GeÃ§miÅŸi</div>
{!hist.length?<div style={{fontFamily:Fm,fontSize:11,color:P.ash}}>HenÃ¼z yok.</div>:<div style={{maxHeight:180,overflowY:"auto"}}>{hist.map((h,i)=><div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"7px 10px",background:i%2===0?P.card:"transparent",borderRadius:6,marginBottom:2}}><div><span style={{fontFamily:Fm,fontSize:11,color:P.mist}}>v{h.version}</span><span style={{fontFamily:Fm,fontSize:10,color:P.ash,marginLeft:8}}>{new Date(h.date).toLocaleString("tr-TR",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}</span></div><button onClick={async()=>{setRb(true);try{await fetch('/api/strategy/rollback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:h.filename})});onApply(await(await fetch('/api/strategy')).json());setHist(await(await fetch('/api/strategy/history')).json());}catch(e){setErr("Hata");}setRb(false);}} disabled={rb} style={{fontFamily:Fs,fontSize:10,fontWeight:600,padding:"4px 12px",borderRadius:6,background:"rgba(249,115,22,0.1)",border:"1px solid rgba(249,115,22,0.25)",color:P.ember,cursor:rb?"wait":"pointer"}}>{rb?"â³":"â†© Geri Al"}</button></div>)}</div>}
</div></div></div></div>;}

function SymbolSearch({mkt,sym,onSelect,presets}){
  const[open,setOpen]=useState(false);const[q,setQ]=useState('');const[results,setResults]=useState([]);const[loading,setLoading]=useState(false);const timer=useRef(null);const ref=useRef(null);
  // Close on outside click
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false);};document.addEventListener('mousedown',h);return()=>document.removeEventListener('mousedown',h);},[]);
  // Search API with debounce
  const search=useCallback(val=>{if(timer.current)clearTimeout(timer.current);if(!val||val.length<1){setResults([]);return;}
    timer.current=setTimeout(async()=>{setLoading(true);try{
      const endpoint=mkt==="crypto"?`/api/search/okx?q=${encodeURIComponent(val)}`:`/api/search/yahoo?q=${encodeURIComponent(val)}`;
      const r=await fetch(endpoint);const data=await r.json();setResults(data.slice(0,10));
    }catch(e){setResults([]);}setLoading(false);},300);
  },[mkt]);
  // Filter presets locally
  const filtered=q?presets.filter(s=>s.toLowerCase().includes(q.toLowerCase())||((DN[s]||'').toLowerCase().includes(q.toLowerCase()))).slice(0,8):presets.slice(0,15);
  const pick=s=>{onSelect(s);setOpen(false);setQ('');setResults([]);};
  return <div ref={ref} style={{position:"relative"}}>
    <button onClick={()=>setOpen(!open)} style={{fontFamily:Fm,fontSize:12,padding:"7px 12px",borderRadius:8,background:P.card,border:`1px solid ${open?P.violet:P.border}`,color:P.mist,cursor:"pointer",minWidth:100,textAlign:"left",fontWeight:600,display:"flex",alignItems:"center",gap:4,transition:"0.2s"}}>{dN(sym)}<span style={{color:P.ash,fontSize:10,marginLeft:"auto"}}>â–¾</span></button>
    {open&&<div style={{position:"absolute",top:"100%",left:0,marginTop:4,width:280,background:P.card,border:`1px solid ${P.border}`,borderRadius:12,boxShadow:"0 12px 40px rgba(0,0,0,0.5)",zIndex:999,overflow:"hidden",animation:"fadeIn 0.15s"}}>
      <div style={{padding:"8px 10px",borderBottom:`1px solid ${P.border}`}}>
        <input value={q} onChange={e=>{setQ(e.target.value);search(e.target.value);}} placeholder={mkt==="crypto"?"BTC, SOL, DOGE...":mkt==="stocks"?"AAPL, TSLA, NVDA...":"AltÄ±n, Petrol, EUR..."} autoFocus style={{width:"100%",background:P.surface,border:`1px solid ${P.border}`,borderRadius:8,padding:"7px 10px",fontFamily:Fm,fontSize:12,color:P.mist,outline:"none"}}/>
      </div>
      <div style={{maxHeight:260,overflowY:"auto"}}>
        {/* API search results */}
        {q&&results.length>0&&<><div style={{padding:"4px 12px",fontFamily:Fm,fontSize:9,color:P.violet,letterSpacing:"0.1em",textTransform:"uppercase"}}>ğŸ” Arama SonuÃ§larÄ±</div>
        {results.map((r,i)=><div key={'api-'+i} onClick={()=>pick(r.symbol)} style={{padding:"7px 12px",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center",transition:"0.15s",background:"transparent"}} onMouseEnter={e=>e.currentTarget.style.background=P.surface} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
          <div><span style={{fontFamily:Fm,fontSize:12,color:P.white,fontWeight:600}}>{r.symbol}</span>{r.name&&r.name!==r.symbol&&<span style={{fontFamily:Fs,fontSize:10,color:P.ash,marginLeft:6}}>{r.name.slice(0,24)}</span>}</div>
          {r.type&&<span style={{fontFamily:Fm,fontSize:9,color:P.ash,background:P.surface,padding:"1px 6px",borderRadius:4}}>{r.type==="EQUITY"?"Hisse":r.type==="CRYPTOCURRENCY"?"Kripto":r.type==="FUTURE"?"Vadeli":r.type==="ETF"?"ETF":r.exchange||r.type}</span>}
        </div>)}</>}
        {q&&loading&&<div style={{padding:"12px",fontFamily:Fm,fontSize:11,color:P.ash,textAlign:"center"}}>AranÄ±yor...</div>}
        {/* Preset list */}
        {filtered.length>0&&<><div style={{padding:"4px 12px",fontFamily:Fm,fontSize:9,color:P.ash,letterSpacing:"0.1em",textTransform:"uppercase",borderTop:q&&results.length?`1px solid ${P.border}`:"none"}}>{q?"Liste":"PopÃ¼ler"}</div>
        {filtered.map(s=><div key={'pre-'+s} onClick={()=>pick(s)} style={{padding:"6px 12px",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center",background:s===sym?"rgba(123,92,245,0.08)":"transparent",transition:"0.15s"}} onMouseEnter={e=>{if(s!==sym)e.currentTarget.style.background=P.surface}} onMouseLeave={e=>{if(s!==sym)e.currentTarget.style.background=s===sym?"rgba(123,92,245,0.08)":"transparent"}}>
          <span style={{fontFamily:Fm,fontSize:11,color:s===sym?P.violet:P.mist,fontWeight:s===sym?700:400}}>{dN(s)}</span>
          {s===sym&&<span style={{fontSize:8,color:P.violet}}>â—</span>}
        </div>)}</>}
        {q&&!loading&&!results.length&&!filtered.length&&<div style={{padding:"16px",textAlign:"center",fontFamily:Fs,fontSize:12,color:P.ash}}>SonuÃ§ bulunamadÄ±</div>}
      </div>
    </div>}
  </div>;
}

// â•â•â• LIVE SIGNAL ENGINE â•â•â•
function calcSignal(bars,livePrice,cfg){
  if(!bars||bars.length<20||!livePrice)return null;
  const{al,man,mA,mP,aL,pD,rOn,rV,eOn,eL}=cfg;
  const last=bars.length-1;
  const p=livePrice;
  const a=_atr(bars,last,aL);
  const ema=_ema(bars,last,eL||10);
  const rsi=_rsi(bars,last);
  const fA=man?mA:a;
  const fT=man?mP:a/pD;

  // Calculate entry levels from current price
  const entries=[];
  let base=p;
  for(let i=0;i<5;i++){
    if(i===0)entries.push({layer:i+1,price:+base.toFixed(4),alloc:al[i],status:"entry"});
    else{base=entries[i-1].price-fA;entries.push({layer:i+1,price:+base.toFixed(4),alloc:al[i],status:"waiting"});}
  }

  // Average entry if all layers filled
  const avgEntry=entries.reduce((s,e)=>s+e.price*e.alloc,0)/entries.reduce((s,e)=>s+e.alloc,0);
  const tp=+(avgEntry+fT).toFixed(4);

  // Determine signal state
  const emaOk=eOn?p<ema:true;
  const rsiOk=rOn?rsi<rV:true;
  let signal="WAIT";let signalColor="#6B7280";
  if(emaOk&&rsiOk){signal="LONG HAZIR";signalColor="#2DC771";}
  if(!emaOk){signal="EMA ÃœSTÃœNDE";signalColor="#F97316";}
  if(rOn&&rsi>70){signal="RSI AÅIRI ALIM";signalColor="#EF4444";}

  // Proximity alerts â€” is price near any entry?
  const alerts=[];
  entries.forEach(e=>{
    const dist=((p-e.price)/p*100);
    const absDist=Math.abs(dist);
    if(absDist<1.5)alerts.push({layer:e.layer,price:e.price,dist:+dist.toFixed(2),hot:absDist<0.5});
  });
  // TP proximity
  const tpDist=((tp-p)/p*100);
  if(Math.abs(tpDist)<2)alerts.push({layer:"TP",price:tp,dist:+tpDist.toFixed(2),hot:Math.abs(tpDist)<0.5});

  return{entries,tp,avgEntry:+avgEntry.toFixed(4),signal,signalColor,ema:+ema.toFixed(4),rsi:+rsi.toFixed(1),atr:+a.toFixed(4),fA:+fA.toFixed(4),fT:+fT.toFixed(4),alerts,livePrice:p};
}

// â•â•â• SIGNAL CARD COMPONENT â•â•â•
function SignalCard({sig,sym,tf}){
  if(!sig)return null;
  const hot=sig.alerts.some(a=>a.hot);
  return <div style={{background:hot?"rgba(239,68,68,0.06)":P.card,border:`1px solid ${hot?"rgba(239,68,68,0.3)":P.border}`,borderRadius:14,padding:14,marginBottom:12,animation:hot?"pulse 1.5s infinite":"fadeIn 0.3s"}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        <div style={{width:10,height:10,borderRadius:5,background:sig.signalColor,animation:"pulse 2s infinite"}}/>
        <span style={{fontFamily:Fd,fontSize:18,color:P.white,fontWeight:700}}>ğŸ“¡ CanlÄ± Sinyal</span>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:6}}>
        <span style={{fontFamily:Fm,fontSize:11,color:P.ash}}>{dN(sym)} â€¢ {tf}</span>
        <span style={{fontFamily:Fm,fontSize:11,fontWeight:700,color:sig.signalColor,background:sig.signalColor+"18",padding:"2px 8px",borderRadius:6}}>{sig.signal}</span>
      </div>
    </div>
    {/* Live Price */}
    <div style={{display:"flex",alignItems:"baseline",gap:8,marginBottom:12}}>
      <span style={{fontFamily:Fm,fontSize:28,fontWeight:700,color:P.white}}>${sig.livePrice.toLocaleString("en")}</span>
      <span style={{fontFamily:Fm,fontSize:11,color:P.ash}}>EMA: ${sig.ema} | RSI: {sig.rsi} | ATR: ${sig.atr}</span>
    </div>
    {/* Entry Levels */}
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(130px,1fr))",gap:6,marginBottom:10}}>
      {sig.entries.map(e=>{
        const dist=((sig.livePrice-e.price)/sig.livePrice*100);
        const near=Math.abs(dist)<1.5;
        const veryNear=Math.abs(dist)<0.5;
        return <div key={e.layer} style={{background:veryNear?"rgba(45,199,113,0.12)":near?"rgba(45,199,113,0.06)":P.surface,border:`1px solid ${veryNear?P.jade+"66":near?P.jade+"33":P.border}`,borderRadius:10,padding:"8px 10px",animation:veryNear?"pulse 1s infinite":"none"}}>
          <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
            <span style={{fontFamily:Fm,fontSize:9,color:veryNear?P.jade:P.ash,letterSpacing:"0.1em",fontWeight:600}}>KATMAN {e.layer}</span>
            <span style={{fontFamily:Fm,fontSize:9,color:P.violet}}>%{e.alloc}</span>
          </div>
          <div style={{fontFamily:Fm,fontSize:14,color:veryNear?P.jade:P.mist,fontWeight:600}}>${e.price.toLocaleString("en")}</div>
          <div style={{fontFamily:Fm,fontSize:10,color:dist>0?P.jade:P.danger}}>{dist>0?"â–¼":"â–²"} {Math.abs(dist).toFixed(2)}%</div>
        </div>;
      })}
      {/* TP Card */}
      <div style={{background:"rgba(123,92,245,0.06)",border:`1px solid rgba(123,92,245,0.3)`,borderRadius:10,padding:"8px 10px"}}>
        <div style={{fontFamily:Fm,fontSize:9,color:P.violet,letterSpacing:"0.1em",fontWeight:600,marginBottom:3}}>ğŸ¯ HEDEF</div>
        <div style={{fontFamily:Fm,fontSize:14,color:P.violet,fontWeight:600}}>${sig.tp.toLocaleString("en")}</div>
        <div style={{fontFamily:Fm,fontSize:10,color:P.ash}}>Ort: ${sig.avgEntry}</div>
      </div>
    </div>
    {/* Proximity Alerts */}
    {sig.alerts.length>0&&<div style={{background:P.surface,borderRadius:8,padding:"8px 10px"}}>
      {sig.alerts.map((a,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:6,padding:"3px 0",fontFamily:Fm,fontSize:11}}>
        <span style={{color:a.hot?P.danger:P.ember,animation:a.hot?"pulse 0.5s infinite":"none"}}>{a.hot?"ğŸ”´":"ğŸŸ¡"}</span>
        <span style={{color:P.mist}}>{a.layer==="TP"?"Hedef":"Katman "+a.layer} <span style={{color:P.white,fontWeight:600}}>${a.price}</span></span>
        <span style={{color:Math.abs(a.dist)<0.5?P.danger:P.ember,fontWeight:600}}>%{a.dist} uzakta</span>
        {a.hot&&<span style={{color:P.danger,fontWeight:700,fontSize:10,animation:"pulse 0.8s infinite"}}>âš¡ YAKIN!</span>}
      </div>)}
    </div>}
  </div>;
}

// â•â•â• PAPER TRADING ENGINE v4 â€” OKX Perpetual Futures Rules â•â•â•
// Flow: coin seÃ§ â†’ OKX'ten max lever Ã§ek â†’ otomatik seÃ§ â†’ %1 risk â†’ kontrat = risk Ã— lever â†’ hacim = kontrat Ã— 2
// Hedge mode: aynÄ± coin'de hem LONG hem SHORT aÃ§Ä±labilir
// Backtest (Martingale) ve Paper Trade BAÄIMSIZ â€” sadece APTR mesafesini paylaÅŸÄ±rlar
function createPaperEngine(initialCap=10000){
  return{
    cap:initialCap,cash:initialCap,peakEq:initialCap,
    bots:{},positions:[],trades:[],nextId:1,startTime:Date.now(),
    riskPct:1,// bakiyenin %1'i riske edilir
    maxPositions:10,// toplam max aÃ§Ä±k pozisyon
    swapInfo:{},// OKX'ten gelen kontrat bilgileri

    getStats(){
      const w=this.trades.filter(t=>t.pnl>0),lo=this.trades.filter(t=>t.pnl<=0);
      const realized=this.trades.reduce((s,t)=>s+t.pnl,0);
      let unrealized=0;
      this.positions.forEach(p=>{
        const lp=this.bots[p.sym]?.lastPrice||p.ep;
        unrealized+=p.side==="LONG"?(lp-p.ep)*p.qty:(p.ep-lp)*p.qty;
      });
      const marginUsed=this.positions.reduce((s,p)=>s+p.margin,0);
      const equity=this.cash+marginUsed+unrealized;
      if(equity>this.peakEq)this.peakEq=equity;
      const dd=this.peakEq>0?+((this.peakEq-equity)/this.peakEq*100).toFixed(2):0;
      return{
        equity:+equity.toFixed(2),cash:+this.cash.toFixed(2),marginUsed:+marginUsed.toFixed(2),
        realized:+realized.toFixed(2),unrealized:+unrealized.toFixed(2),
        totalTrades:this.trades.length,openCount:this.positions.length,
        winRate:this.trades.length?+(w.length/this.trades.length*100).toFixed(1):0,
        wins:w.length,losses:lo.length,maxDD:dd,
        longCount:this.positions.filter(p=>p.side==="LONG").length,
        shortCount:this.positions.filter(p=>p.side==="SHORT").length,
      };
    },

    tick(sym,price){
      const b=this.bots[sym];
      if(!b||!b.active)return null;
      b.lastPrice=price;
      const events=[];
      const base=sym.replace("-USDT","");
      const si=this.swapInfo[base]||{maxLever:20,ctVal:1};
      const maxLev=si.maxLever;
      const riskPct=this.riskPct;

      // â”€â”€ 1) Check SL / TP / Liq on existing positions (copy array to avoid mutation issues) â”€â”€
      const toClose=[];
      this.positions.filter(p=>p.sym===sym).forEach(p=>{
        // Skip positions opened less than 3 seconds ago (cooldown to avoid instant SL)
        if(Date.now()-p.time<3000)return;
        let hit=null;
        if(p.side==="LONG"){
          if(price<=p.liq)hit={type:"LIQ",px:price};
          else if(price<=p.sl)hit={type:"SL",px:p.sl};
          else if(price>=p.tp)hit={type:"TP",px:p.tp};
        }else{
          if(price>=p.liq)hit={type:"LIQ",px:price};
          else if(price>=p.sl)hit={type:"SL",px:p.sl};
          else if(price<=p.tp)hit={type:"TP",px:p.tp};
        }
        if(hit)toClose.push({pos:p,hit});
      });

      // Process closures
      toClose.forEach(({pos:p,hit})=>{
        let pnl;
        if(hit.type==="LIQ"){pnl=-p.margin;}
        else{pnl=p.side==="LONG"?(hit.px-p.ep)*p.qty:(p.ep-hit.px)*p.qty;}
        if(hit.type!=="LIQ")this.cash+=p.margin+pnl;
        // else margin is lost (already deducted)
        this.trades.push({sym,side:p.side,entry:+p.ep.toFixed(2),exit:+hit.px.toFixed(2),qty:+p.qty.toFixed(6),margin:p.margin,notional:p.notional,lever:p.lever,sl:+p.sl.toFixed(2),tp:+p.tp.toFixed(2),liq:+p.liq.toFixed(2),volume:p.volume,pnl:+pnl.toFixed(2),pnlPct:+((pnl/p.margin)*100).toFixed(2),result:hit.type,time:Date.now()});
        events.push({type:hit.type,side:p.side,sym,price:+hit.px.toFixed(2),pnl:+pnl.toFixed(2),lever:p.lever});
      });
      if(toClose.length){
        const closedIds=new Set(toClose.map(c=>c.pos.id));
        this.positions=this.positions.filter(p=>!closedIds.has(p.id));
      }

      // â”€â”€ 2) Position sizing (OKX futures rules) â”€â”€
      const equity=this.cash+this.positions.reduce((s,p)=>s+p.margin,0);
      const riskAmt=equity*(riskPct/100);// %1 risk = $100 on $10K
      const margin=+riskAmt.toFixed(2);
      const notional=+(margin*maxLev).toFixed(0);// kontrat deÄŸeri
      const qty=notional/price;// coin adedi
      const volume=notional*2;// hacim = kontrat Ã— 2
      // SL distance: loss at SL = riskAmt â†’ slDist = riskAmt / qty = price / maxLev
      const slDist=riskAmt/qty;
      const tpDist=slDist*2;// R:R 1:2
      const liqDist=(price/maxLev)*0.9;// isolated margin liq

      // Max position check
      if(this.positions.length>=this.maxPositions)return events.length?events:null;
      if(this.cash<margin)return events.length?events:null;

      // â”€â”€ 3) LONG entry â€” Martingale katman aralÄ±ÄŸÄ± backtestten gelir (APTR) â”€â”€
      const fA=b.cfg.mA||80;// APTR mesafesi â€” backtestle paylaÅŸÄ±lan tek parametre
      const curLongs=this.positions.filter(p=>p.sym===sym&&p.side==="LONG");
      if(!curLongs.length){
        if(this.cash>=margin){
          const ep=price;
          const pos={id:this.nextId++,sym,side:"LONG",qty,ep,margin,notional,lever:maxLev,sl:+(ep-slDist).toFixed(4),tp:+(ep+tpDist).toFixed(4),liq:+(ep-liqDist).toFixed(4),volume:+volume.toFixed(0),time:Date.now()};
          this.positions.push(pos);this.cash-=margin;
          events.push({type:"OPEN",side:"LONG",sym,layer:1,price:ep,margin,notional,qty:+qty.toFixed(6),sl:pos.sl,tp:pos.tp,liq:pos.liq,lever:maxLev,volume:+volume.toFixed(0)});
        }
      }else if(curLongs.length<5){
        const lastEp=curLongs[curLongs.length-1].ep;
        if(price<lastEp-fA&&this.cash>=margin&&this.positions.length<this.maxPositions){
          const ly=curLongs.length+1;const ep=price;
          const pos={id:this.nextId++,sym,side:"LONG",qty,ep,margin,notional,lever:maxLev,sl:+(ep-slDist).toFixed(4),tp:+(ep+tpDist).toFixed(4),liq:+(ep-liqDist).toFixed(4),volume:+volume.toFixed(0),time:Date.now()};
          this.positions.push(pos);this.cash-=margin;
          events.push({type:"OPEN",side:"LONG",sym,layer:ly,price:ep,margin,notional,qty:+qty.toFixed(6),sl:pos.sl,tp:pos.tp,liq:pos.liq,lever:maxLev,volume:+volume.toFixed(0)});
        }
      }

      // â”€â”€ 4) SHORT entry â€” HEDGE MODE (baÄŸÄ±msÄ±z, aynÄ± anda long+short) â”€â”€
      const curShorts=this.positions.filter(p=>p.sym===sym&&p.side==="SHORT");
      if(!curShorts.length){
        if(b.basePrice&&price>b.basePrice+fA&&this.cash>=margin&&this.positions.length<this.maxPositions){
          const ep=price;
          const pos={id:this.nextId++,sym,side:"SHORT",qty,ep,margin,notional,lever:maxLev,sl:+(ep+slDist).toFixed(4),tp:+(ep-tpDist).toFixed(4),liq:+(ep+liqDist).toFixed(4),volume:+volume.toFixed(0),time:Date.now()};
          this.positions.push(pos);this.cash-=margin;
          events.push({type:"OPEN",side:"SHORT",sym,layer:1,price:ep,margin,notional,qty:+qty.toFixed(6),sl:pos.sl,tp:pos.tp,liq:pos.liq,lever:maxLev,volume:+volume.toFixed(0)});
        }
      }else if(curShorts.length<3){
        const lastEp=curShorts[curShorts.length-1].ep;
        if(price>lastEp+fA&&this.cash>=margin&&this.positions.length<this.maxPositions){
          const ly=curShorts.length+1;const ep=price;
          const pos={id:this.nextId++,sym,side:"SHORT",qty,ep,margin,notional,lever:maxLev,sl:+(ep+slDist).toFixed(4),tp:+(ep-tpDist).toFixed(4),liq:+(ep+liqDist).toFixed(4),volume:+volume.toFixed(0),time:Date.now()};
          this.positions.push(pos);this.cash-=margin;
          events.push({type:"OPEN",side:"SHORT",sym,layer:ly,price:ep,margin,notional,qty:+qty.toFixed(6),sl:pos.sl,tp:pos.tp,liq:pos.liq,lever:maxLev,volume:+volume.toFixed(0)});
        }
      }
      return events.length?events:null;
    }
  };
}

// â•â•â• PAPER TRADING PANEL v4 â€” OKX Auto Leverage, %1 Risk, Hedge Mode â•â•â•
function PaperPanel({engine,setEngine,syms,cfg,tick,setTick}){
  const[selected,setSelected]=useState([]);
  const[running,setRunning]=useState(false);
  const[expanded,setExpanded]=useState(true);
  const[logs,setLogs]=useState([]);
  const[swapInfo,setSwapInfo]=useState(null);// OKX SWAP kontrat bilgileri
  const[loading,setLoading]=useState(false);
  const wsRefs=useRef({});
  const engineRef=useRef(engine);
  engineRef.current=engine;

  const topCoins=syms.filter(s=>s.endsWith("-USDT")).slice(0,20);
  const toggleCoin=s=>setSelected(prev=>prev.includes(s)?prev.filter(x=>x!==s):[...prev,s]);

  // Fetch OKX SWAP instruments on mount
  useEffect(()=>{
    fetch('/api/okx/swap-info').then(r=>r.json()).then(d=>{if(d&&Object.keys(d).length)setSwapInfo(d);}).catch(()=>{});
  },[]);

  const getLev=(sym)=>{
    const base=sym.replace("-USDT","");
    return swapInfo?.[base]?.maxLever||20;
  };

  const start=()=>{
    if(!selected.length)return;
    setLoading(true);
    const eng=createPaperEngine(10000);
    eng.riskPct=1;// sabit %1
    if(swapInfo)eng.swapInfo=swapInfo;
    const mA=cfg?.smartDefaults?.OTHER?.aptr?.[1]||80;
    selected.forEach(sym=>{
      eng.bots[sym]={cfg:{mA},active:true,lastPrice:null,basePrice:null};
    });
    setEngine(eng);setRunning(true);setLoading(false);
    const levList=selected.map(s=>s.replace("-USDT","")+"("+getLev(s)+"x)").join(", ");
    setLogs([{t:Date.now(),msg:`ğŸš€ Futures Paper â€” $10K â€” Risk %1 â€” Hedge Mode ON â€” ${selected.length} coin`},{t:Date.now()-1,msg:`âš¡ KaldÄ±raÃ§lar: ${levList}`}]);

    Object.keys(wsRefs.current).forEach(k=>{try{wsRefs.current[k].close();}catch(e){}});
    wsRefs.current={};
    selected.forEach(sym=>{
      try{
        const w=new WebSocket('wss://ws.okx.com:8443/ws/v5/public');
        w.onopen=()=>{w.send(JSON.stringify({op:"subscribe",args:[{channel:"trades",instId:sym}]}));};
        w.onmessage=e=>{
          try{
            const d=JSON.parse(e.data);
            if(!d.data||!d.data[0])return;
            const px=+parseFloat(d.data[0].px);
            if(!engineRef.current)return;
            const bot=engineRef.current.bots[sym];
            if(bot&&!bot.basePrice)bot.basePrice=px;
            const evts=engineRef.current.tick(sym,px);
            if(evts){
              setLogs(prev=>[...evts.map(ev=>{
                const cn=ev.sym.replace("-USDT","");
                if(ev.type==="OPEN"){
                  const ico=ev.side==="LONG"?"ğŸŸ¢":"ğŸ”´";
                  return{t:Date.now(),msg:`${ico} ${ev.side} ${cn} K${ev.layer} | ${ev.lever}x | $${ev.price.toFixed(2)} | Mrj:$${ev.margin} | Poz:$${ev.notional} | Vol:$${ev.volume} | SL:$${ev.sl} TP:$${ev.tp}`};
                }
                if(ev.type==="TP")return{t:Date.now(),msg:`âœ… TP ${ev.side} ${cn} | ${ev.lever}x â€” $${ev.price} â€” +$${ev.pnl}`};
                if(ev.type==="SL")return{t:Date.now(),msg:`â›” SL ${ev.side} ${cn} | ${ev.lever}x â€” $${ev.price} â€” $${ev.pnl}`};
                if(ev.type==="LIQ")return{t:Date.now(),msg:`ğŸ’€ LIQ ${ev.side} ${cn} â€” $${Math.abs(ev.pnl)} margin kaybedildi`};
                return{t:Date.now(),msg:JSON.stringify(ev)};
              }),...prev].slice(0,100));
              setTick(prev=>prev+1);// trigger re-render without breaking engine methods
            }
          }catch(err){}
        };
        wsRefs.current[sym]=w;
      }catch(e){}
    });
  };

  const stop=()=>{
    setRunning(false);
    Object.keys(wsRefs.current).forEach(k=>{try{wsRefs.current[k].close();}catch(e){}});
    wsRefs.current={};
    setLogs(prev=>[{t:Date.now(),msg:"â¹ Durduruldu"},...prev]);
  };

  useEffect(()=>()=>{Object.keys(wsRefs.current).forEach(k=>{try{wsRefs.current[k].close();}catch(e){}});},[]);

  // Periodic re-render for live unrealized PnL (every 2s while running)
  useEffect(()=>{
    if(!running)return;
    const iv=setInterval(()=>setTick(p=>p+1),2000);
    return()=>clearInterval(iv);
  },[running,setTick]);

  // Use engineRef for live data (tick counter forces re-render)
  const eng=engineRef.current;
  const stats=eng?.getStats?.();
  const eq=stats?.equity||10000;
  const ret=stats?((eq-10000)/10000*100):0;

  return <div style={{position:"fixed",bottom:0,left:0,right:0,zIndex:998,background:P.card,borderTop:`2px solid ${running?P.jade:P.border}`,boxShadow:"0 -8px 30px rgba(0,0,0,0.4)"}}>
    {/* Toggle Bar */}
    <div onClick={()=>setExpanded(!expanded)} style={{padding:"8px 18px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",borderBottom:expanded?`1px solid ${P.border}`:"none"}}>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        <span style={{fontSize:16}}>{running?"ğŸ“ˆ":"ğŸ’°"}</span>
        <span style={{fontFamily:Fd,fontSize:16,color:P.white,fontWeight:700}}>Futures <span style={{color:P.violet}}>Paper</span></span>
        {running&&<div style={{width:8,height:8,borderRadius:4,background:P.jade,animation:"pulse 1.5s infinite"}}/>}
        {running&&stats&&<span style={{fontFamily:Fm,fontSize:12,color:ret>=0?P.jade:P.danger,fontWeight:600,marginLeft:8}}>${eq.toLocaleString("en")} ({ret>=0?"+":""}{ret.toFixed(2)}%)</span>}
      </div>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        {running&&stats&&<>
          <span style={{fontFamily:Fm,fontSize:10,color:P.ash}}>Risk %1</span>
          <span style={{fontFamily:Fm,fontSize:10,color:P.ash}}>Hedge</span>
          <span style={{fontFamily:Fm,fontSize:10,color:P.ash}}>WR:{stats.winRate}%</span>
          <span style={{fontFamily:Fm,fontSize:10,color:P.jade}}>L:{stats.longCount}</span>
          <span style={{fontFamily:Fm,fontSize:10,color:P.danger}}>S:{stats.shortCount}</span>
        </>}
        <span style={{fontFamily:Fm,fontSize:14,color:P.ash,transform:expanded?"rotate(180deg)":"none",transition:"0.2s"}}>â–²</span>
      </div>
    </div>

    {expanded&&<div style={{padding:"12px 18px",maxHeight:400,overflowY:"auto"}}>
      {!running?<>
        <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:6,fontWeight:600}}>OKX PERPETUAL FUTURES â€” PAPER TRADE</div>

        {/* Info Box */}
        <div style={{background:P.surface,borderRadius:8,padding:"8px 12px",marginBottom:10,fontFamily:Fm,fontSize:10,lineHeight:1.6}}>
          <div style={{color:P.mist}}>ğŸ“‹ <span style={{color:P.white,fontWeight:600}}>Kurallar:</span></div>
          <div style={{color:P.ash}}>â€¢ Coin seÃ§ â†’ OKX'ten max kaldÄ±raÃ§ otomatik gelir</div>
          <div style={{color:P.ash}}>â€¢ Her iÅŸlemde bakiyenin <span style={{color:P.ember,fontWeight:600}}>%1</span>'i riske edilir â†’ Risk = $100</div>
          <div style={{color:P.ash}}>â€¢ Kontrat = Risk Ã— KaldÄ±raÃ§ â†’ Ã¶rn: $100 Ã— 125x = <span style={{color:P.white,fontWeight:600}}>$12,500</span></div>
          <div style={{color:P.ash}}>â€¢ Hacim = Kontrat Ã— 2 â†’ <span style={{color:P.cobalt,fontWeight:600}}>$25,000</span></div>
          <div style={{color:P.ash}}>â€¢ <span style={{color:P.jade}}>Hedge Mode</span>: AynÄ± coin'de eÅŸ zamanlÄ± Long + Short</div>
          <div style={{color:P.ash}}>â€¢ R:R 1:2 â€¢ SL ve TP otomatik â€¢ Max <span style={{color:P.ember,fontWeight:600}}>10 pozisyon</span></div>
          <div style={{color:P.ash,fontSize:9,marginTop:2}}>âš ï¸ Backtest (Martingale) ve Paper Trade baÄŸÄ±msÄ±z â€” sadece APTR katman mesafesini paylaÅŸÄ±r</div>
        </div>

        {/* Coin Selection with leverage badges */}
        <div style={{fontFamily:Fm,fontSize:9,color:P.ash,marginBottom:4}}>Coin seÃ§ {swapInfo?"(OKX max kaldÄ±raÃ§ gÃ¶sterilir)":"(yÃ¼kleniyor...)"}:</div>
        <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:10}}>
          {topCoins.map(s=>{
            const base=s.replace("-USDT","");
            const ml=swapInfo?.[base]?.maxLever;
            const sel=selected.includes(s);
            return <button key={s} onClick={()=>toggleCoin(s)} style={{fontFamily:Fm,fontSize:10,fontWeight:600,padding:"5px 10px",borderRadius:6,background:sel?"rgba(123,92,245,0.15)":"transparent",border:`1px solid ${sel?P.violet:P.border}`,color:sel?P.violet:P.ash,cursor:"pointer",display:"flex",alignItems:"center",gap:4}}>
              {base}
              {ml&&<span style={{fontSize:8,color:sel?P.ember:P.ash,fontWeight:700,background:sel?"rgba(249,115,22,0.1)":"transparent",padding:"0 3px",borderRadius:3}}>{ml}x</span>}
            </button>;
          })}
        </div>

        {/* Selected summary */}
        {selected.length>0&&<div style={{background:P.surface,borderRadius:8,padding:"8px 12px",marginBottom:10,display:"flex",gap:12,flexWrap:"wrap",fontFamily:Fm,fontSize:10}}>
          {selected.map(s=>{
            const base=s.replace("-USDT","");const ml=getLev(s);
            const risk=100;const notional=risk*ml;const vol=notional*2;
            return <div key={s} style={{display:"flex",alignItems:"center",gap:6,background:P.card,padding:"4px 8px",borderRadius:6,border:`1px solid ${P.border}`}}>
              <span style={{color:P.white,fontWeight:700}}>{base}</span>
              <span style={{color:P.ember,fontSize:9}}>{ml}x</span>
              <span style={{color:P.ash,fontSize:9}}>Kontrat: ${notional.toLocaleString()}</span>
              <span style={{color:P.cobalt,fontSize:9}}>Hacim: ${vol.toLocaleString()}</span>
            </div>;
          })}
        </div>}

        <button onClick={start} disabled={!selected.length||loading} style={{fontFamily:Fs,fontSize:12,fontWeight:700,padding:"9px 24px",borderRadius:10,background:selected.length?`linear-gradient(135deg,${P.jade},#1a9d5c)`:"#2A2D3A",border:"none",color:P.white,cursor:selected.length?"pointer":"not-allowed",boxShadow:selected.length?`0 4px 16px ${P.jade}40`:"none"}}>ğŸš€ BaÅŸlat â€” {selected.length} coin â€” Hedge Mode â€” %1 Risk</button>
      </>:<>
        {/* Stats */}
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(85px,1fr))",gap:4,marginBottom:8}}>
          {[
            ["BAKÄ°YE","$"+eq.toLocaleString("en"),ret>=0?P.jade:P.danger],
            ["MARJÄ°N","$"+(stats?.marginUsed||0).toLocaleString("en"),P.violet],
            ["REALIZED",(stats?.realized>=0?"+":"")+stats?.realized,stats?.realized>=0?P.jade:P.danger],
            ["UNREALIZED",(stats?.unrealized>=0?"+":"")+(stats?.unrealized||0).toFixed(2),stats?.unrealized>=0?P.jade:P.danger],
            ["WIN RATE",(stats?.winRate||0)+"%",stats?.winRate>=50?P.jade:P.danger],
            ["W / L",(stats?.wins||0)+" / "+(stats?.losses||0),P.mist],
            ["MAX DD",(stats?.maxDD||0)+"%",P.danger],
            ["HEDGE",stats?.longCount+"L / "+stats?.shortCount+"S","#F59E0B"],
          ].map(([l,v,c],i)=><div key={i} style={{background:P.surface,borderRadius:6,padding:"5px 7px"}}><div style={{fontFamily:Fm,fontSize:7,color:P.ash,letterSpacing:"0.08em"}}>{l}</div><div style={{fontFamily:Fm,fontSize:12,fontWeight:600,color:c}}>{v}</div></div>)}
        </div>

        {/* Open Positions */}
        {eng?.positions?.length>0&&<div style={{marginBottom:6}}>
          <div style={{fontFamily:Fm,fontSize:9,color:P.ember,letterSpacing:"0.1em",marginBottom:3,fontWeight:600}}>AÃ‡IK POZÄ°SYONLAR ({eng.positions.length}) â€” HEDGE MODE</div>
          <div style={{overflowX:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontFamily:Fm,fontSize:9}}>
            <thead><tr>{["#","Coin","YÃ¶n","KaldÄ±raÃ§","GiriÅŸ","Åimdi","Margin","Kontrat","Hacim","SL","TP","Liq","K/Z","ROI%"].map(h=><th key={h} style={{textAlign:"left",padding:"3px 4px",color:P.ash,fontSize:8,borderBottom:`1px solid ${P.border}`,whiteSpace:"nowrap"}}>{h}</th>)}</tr></thead>
            <tbody>{eng.positions.map(p=>{
              const lp=eng.bots[p.sym]?.lastPrice||p.ep;
              const uPnl=p.side==="LONG"?(lp-p.ep)*p.qty:(p.ep-lp)*p.qty;
              const roi=((uPnl/p.margin)*100);
              return <tr key={p.id} style={{borderBottom:`1px solid ${P.border}`}}>
                <td style={{padding:"2px 4px",color:P.ash}}>{p.id}</td>
                <td style={{padding:"2px 4px",color:P.white,fontWeight:600}}>{p.sym.replace("-USDT","")}</td>
                <td style={{padding:"2px 4px"}}><span style={{background:p.side==="LONG"?P.jade+"20":P.danger+"20",color:p.side==="LONG"?P.jade:P.danger,padding:"1px 5px",borderRadius:3,fontWeight:700,fontSize:8}}>{p.side}</span></td>
                <td style={{padding:"2px 4px",color:P.ember,fontWeight:600}}>{p.lever}x</td>
                <td style={{padding:"2px 4px"}}>${p.ep.toFixed(2)}</td>
                <td style={{padding:"2px 4px",fontWeight:600}}>${lp.toFixed(2)}</td>
                <td style={{padding:"2px 4px",color:P.violet}}>${p.margin}</td>
                <td style={{padding:"2px 4px",color:P.white}}>${p.notional}</td>
                <td style={{padding:"2px 4px",color:P.cobalt,fontWeight:600}}>${p.volume}</td>
                <td style={{padding:"2px 4px",color:P.danger}}>{p.sl}</td>
                <td style={{padding:"2px 4px",color:P.jade}}>{p.tp}</td>
                <td style={{padding:"2px 4px",color:"#F59E0B"}}>{p.liq}</td>
                <td style={{padding:"2px 4px",color:uPnl>=0?P.jade:P.danger,fontWeight:600}}>{uPnl>=0?"+":""}{uPnl.toFixed(2)}</td>
                <td style={{padding:"2px 4px",color:uPnl>=0?P.jade:P.danger}}>{roi>=0?"+":""}{roi.toFixed(1)}%</td>
              </tr>;
            })}</tbody>
          </table></div>
        </div>}

        {/* Closed Trades */}
        {eng?.trades?.length>0&&<div style={{marginBottom:6}}>
          <div style={{fontFamily:Fm,fontSize:9,color:P.violet,letterSpacing:"0.1em",marginBottom:3,fontWeight:600}}>KAPANMIÅ ({eng.trades.length})</div>
          <div style={{overflowX:"auto",maxHeight:70,overflowY:"auto"}}><table style={{width:"100%",borderCollapse:"collapse",fontFamily:Fm,fontSize:9}}>
            <thead><tr>{["Coin","YÃ¶n","KaldÄ±raÃ§","GiriÅŸ","Ã‡Ä±kÄ±ÅŸ","Hacim","SonuÃ§","K/Z","ROI%"].map(h=><th key={h} style={{textAlign:"left",padding:"2px 4px",color:P.ash,fontSize:8,borderBottom:`1px solid ${P.border}`,position:"sticky",top:0,background:P.card,whiteSpace:"nowrap"}}>{h}</th>)}</tr></thead>
            <tbody>{[...eng.trades].reverse().map((t,i)=><tr key={i} style={{borderBottom:`1px solid ${P.border}`}}>
              <td style={{padding:"2px 4px",color:P.white,fontWeight:600}}>{t.sym.replace("-USDT","")}</td>
              <td style={{padding:"2px 4px"}}><span style={{background:t.side==="LONG"?P.jade+"20":P.danger+"20",color:t.side==="LONG"?P.jade:P.danger,padding:"1px 4px",borderRadius:3,fontWeight:700,fontSize:8}}>{t.side}</span></td>
              <td style={{padding:"2px 4px",color:P.ember}}>{t.lever}x</td>
              <td style={{padding:"2px 4px"}}>${t.entry}</td>
              <td style={{padding:"2px 4px"}}>${t.exit}</td>
              <td style={{padding:"2px 4px",color:P.cobalt}}>${t.volume}</td>
              <td style={{padding:"2px 4px"}}><span style={{padding:"1px 5px",borderRadius:3,fontSize:8,fontWeight:700,background:t.result==="TP"?P.jade+"20":t.result==="SL"?P.danger+"20":"#F59E0B20",color:t.result==="TP"?P.jade:t.result==="SL"?P.danger:"#F59E0B"}}>{t.result}</span></td>
              <td style={{padding:"2px 4px",color:t.pnl>=0?P.jade:P.danger,fontWeight:600}}>{t.pnl>=0?"+":""}${t.pnl}</td>
              <td style={{padding:"2px 4px",color:t.pnl>=0?P.jade:P.danger}}>{t.pnlPct>=0?"+":""}{t.pnlPct}%</td>
            </tr>)}</tbody>
          </table></div>
        </div>}

        {/* Log + Stop */}
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
          <span style={{fontFamily:Fm,fontSize:8,color:P.ash}}>LOG</span>
          <button onClick={stop} style={{fontFamily:Fs,fontSize:10,fontWeight:600,padding:"4px 14px",borderRadius:6,background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.25)",color:P.danger,cursor:"pointer"}}>â¹ Durdur</button>
        </div>
        <div style={{maxHeight:60,overflowY:"auto",background:P.surface,borderRadius:6,padding:4}}>
          {logs.map((l,i)=><div key={i} style={{fontFamily:Fm,fontSize:9,color:P.mist,padding:"2px 4px",borderBottom:`1px solid ${P.border}`}}>
            <span style={{color:P.ash,marginRight:4}}>{new Date(l.t).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}</span>{l.msg}
          </div>)}
          {!logs.length&&<div style={{fontFamily:Fm,fontSize:9,color:P.ash,textAlign:"center",padding:6}}>Sinyal bekleniyor...</div>}
        </div>
      </>}
    </div>}
  </div>;
}

function App(){
  const[cfg,setCfg]=useState(null);const[showTut,setShowTut]=useState(true);const[showDev,setShowDev]=useState(false);
  const[mkt,setMkt]=useState("crypto");const[sym,setSym]=useState("ETH-USDT");const[tf,setTf]=useState("1H");
  const[a1,sA1]=useState(10);const[a2,sA2]=useState(15);const[a3,sA3]=useState(20);const[a4,sA4]=useState(25);const[a5,sA5]=useState(30);
  const[man,setMan]=useState(true);const[mA,setMA]=useState(80);const[mP,setMP]=useState(40);
  const[aL,setAL]=useState(14);const[pD,setPD]=useState(2);const[rOn,setROn]=useState(false);const[rV,setRV]=useState(71);const[eOn,setEOn]=useState(true);
  const[res,setRes]=useState(null);const[bars,setBars]=useState(null);const[tab,setTab]=useState("candles");const[st,setSt]=useState("idle");
  const[lP,setLP]=useState(null);const[err,setErr]=useState(null);const ws=useRef(null);
  const[sig,setSig]=useState(null);const[sigOn,setSigOn]=useState(false);
  const[paperEng,setPaperEng]=useState(null);
  const[paperTick,setPaperTick]=useState(0);// force re-render counter

  // Recalculate signal whenever live price changes
  useEffect(()=>{
    if(!sigOn||!bars||!lP||mkt!=="crypto")return;
    const s=calcSignal(bars,lP,{al:[a1,a2,a3,a4,a5],man,mA,mP,aL,pD,rOn,rV,eOn,eL:cfg?.defaults?.emaLength||10});
    setSig(s);
  },[lP,sigOn,bars,a1,a2,a3,a4,a5,man,mA,mP,aL,pD,rOn,rV,eOn,cfg,mkt]);

  const applyCfg=useCallback(c=>{setCfg(c);if(c.defaults){setMan(c.defaults.useManual!==false);setEOn(c.defaults.useEma!==false);setROn(c.defaults.useRsi===true);setRV(c.defaults.rsiLevel||71);setAL(c.defaults.atrLength||14);setPD(c.defaults.profitDivisor||2);}if(c.allocations){sA1(c.allocations.layer1||10);sA2(c.allocations.layer2||15);sA3(c.allocations.layer3||20);sA4(c.allocations.layer4||25);sA5(c.allocations.layer5||30);}},[]);
  useEffect(()=>{fetch('/api/strategy').then(r=>r.json()).then(applyCfg).catch(()=>{});},[applyCfg]);

  const mktCfg=cfg?.markets?.[mkt];const syms=mktCfg?.symbols||["ETH-USDT"];const tfs=mktCfg?.timeframes||[{label:"1s",value:"1H",limit:300}];
  const changeMkt=useCallback(m=>{setMkt(m);const mc=cfg?.markets?.[m];if(mc){setSym(mc.symbols[0]);setTf(mc.timeframes[0].value);}setLP(null);setRes(null);setBars(null);setSt("idle");},[cfg]);

  const getSD=useCallback((s,t)=>{if(!man||!cfg)return;const sd=cfg.smartDefaults||{};const sg=cfg.symbolGroups||{};const m=Math.max(0,tfs.findIndex(x=>x.value===t));let g="OTHER";if(mkt==="stocks")g="STOCK";else if(mkt==="commodities")g="COMMODITY";else if(s.startsWith("BTC"))g="BTC";else if(s.startsWith("ETH"))g="ETH";else if(s.startsWith("BNB"))g="BNB";else if((sg.MID||[]).includes(s))g="MID";else if((sg.LOW||[]).includes(s))g="LOW";const d=sd[g]||sd.OTHER;if(d){setMA(d.aptr[Math.min(m,d.aptr.length-1)]);setMP(d.profit[Math.min(m,d.profit.length-1)]);}},[man,cfg,mkt,tfs]);

  const run=useCallback(async()=>{setSt("loading");setErr(null);try{const tfObj=tfs.find(t=>t.value===tf)||tfs[0];const d=await fetchData(mkt,sym,tfObj);if(!d.length)throw new Error("Veri yok");setBars(d);setRes(backtest(d,{al:[a1,a2,a3,a4,a5],man,mA,mP,aL,pD,rOn,rV,eOn,eL:cfg?.defaults?.emaLength||10,cap:cfg?.defaults?.initialCapital||10000}));setSt("done");}catch(e){setErr(e.message);setSt("error");}},[sym,tf,mkt,a1,a2,a3,a4,a5,man,mA,mP,aL,pD,rOn,rV,eOn,cfg,tfs]);

  useEffect(()=>{if(ws.current)ws.current.close();setLP(null);if(mkt!=="crypto")return;try{const w=new WebSocket('wss://ws.okx.com:8443/ws/v5/public');w.onopen=()=>{w.send(JSON.stringify({op:"subscribe",args:[{channel:"trades",instId:sym}]}));};w.onmessage=e=>{try{const d=JSON.parse(e.data);if(d.data&&d.data[0])setLP(+parseFloat(d.data[0].px).toFixed(4));}catch{}};ws.current=w;}catch{}return()=>{if(ws.current)ws.current.close();};},[sym,mkt]);

  const s=res?.s,rc=s?(s.ret>=0?P.jade:P.danger):P.mist,aT=a1+a2+a3+a4+a5;

  return <div style={{minHeight:"100vh",background:P.ink,color:P.mist,fontFamily:Fs}}>
    {showTut&&<Onboarding onClose={()=>setShowTut(false)}/>}
    <DevConsole open={showDev} onClose={()=>setShowDev(false)} cfg={cfg} onApply={c=>{applyCfg(c);setShowDev(false);}}/>
    {/* HEADER */}
    <div style={{padding:"10px 18px",borderBottom:`1px solid ${P.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:8,background:`linear-gradient(180deg,${P.card},${P.ink})`}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}><img src={LOGO} width="30" height="30" style={{borderRadius:8}}/><div><h1 style={{fontFamily:Fd,fontSize:20,fontWeight:700,color:P.white}}>Martingale <span style={{color:P.violet}}>V2</span></h1><p style={{fontFamily:Fm,fontSize:8,color:P.ash}}>MULTI-MARKET â€¢ v{cfg?._version||"3.0"}</p></div></div>
      <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
        {lP&&<div style={{fontFamily:Fm,fontSize:13,color:P.jade,display:"flex",alignItems:"center",gap:5,fontWeight:600}}><div style={{width:7,height:7,borderRadius:4,background:P.jade,animation:"pulse 2s infinite"}}/>${lP.toLocaleString("en")}</div>}
        <select value={mkt} onChange={e=>changeMkt(e.target.value)} style={{fontWeight:600,background:mkt==="crypto"?"rgba(123,92,245,0.15)":mkt==="stocks"?"rgba(45,199,113,0.15)":"rgba(249,115,22,0.15)"}}>{cfg?.markets?Object.entries(cfg.markets).map(([k,v])=><option key={k} value={k}>{v.label}</option>):<><option value="crypto">ğŸª™ Kripto</option><option value="stocks">ğŸ“ˆ Hisse</option><option value="commodities">ğŸ—ï¸ Emtia</option></>}</select>
        <SymbolSearch mkt={mkt} sym={sym} presets={syms} onSelect={s=>{setSym(s);getSD(s,tf);}}/>
        <select value={tf} onChange={e=>{setTf(e.target.value);getSD(sym,e.target.value);}}>{tfs.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select>
        <button onClick={run} disabled={st==="loading"} style={{fontFamily:Fs,fontSize:12,fontWeight:700,padding:"7px 18px",borderRadius:10,background:st==="loading"?"#2A2D3A":`linear-gradient(135deg,${P.violet},${P.cobalt})`,border:"none",color:P.white,cursor:st==="loading"?"wait":"pointer",boxShadow:st!=="loading"?`0 4px 20px ${P.violet}40`:"none"}}>{st==="loading"?"â³":"â–¶ RUN"}</button>
        <button onClick={()=>setShowDev(true)} style={{fontFamily:Fm,fontSize:11,padding:"7px 12px",borderRadius:8,background:"rgba(249,115,22,0.1)",border:"1px solid rgba(249,115,22,0.25)",color:P.ember,cursor:"pointer",fontWeight:600}}>&lt;/&gt;</button>
        <button onClick={()=>setShowTut(true)} style={{fontFamily:Fs,fontSize:11,padding:"7px 10px",borderRadius:8,background:"transparent",border:`1px solid ${P.border}`,color:P.ash,cursor:"pointer"}}>â“</button>
      </div>
    </div>
    {err&&<div style={{margin:"8px 18px",padding:"10px 14px",background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.danger}}>âš  {err}</div>}
    <div style={{display:"flex",height:"calc(100vh - 56px)"}}>
      {/* SIDEBAR */}
      <div style={{width:250,minWidth:250,borderRight:`1px solid ${P.border}`,padding:"14px 12px",overflowY:"auto",background:P.card+"88"}}>
        <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Allocation</div>
        <Sld l="Katman 1" v={a1} set={sA1} min={1} max={50} suf="%" tip="Ä°lk alÄ±m."/><Sld l="Katman 2" v={a2} set={sA2} min={1} max={50} suf="%"/><Sld l="Katman 3" v={a3} set={sA3} min={1} max={50} suf="%"/><Sld l="Katman 4" v={a4} set={sA4} min={1} max={50} suf="%"/><Sld l="Katman 5" v={a5} set={sA5} min={1} max={50} suf="%" tip="Son katman. âš  Stop-loss yok!"/>
        <div style={{fontFamily:Fm,fontSize:11,color:aT===100?P.jade:P.ember,marginBottom:4,fontWeight:600}}>Toplam: {aT}%{aT!==100&&" âš "}</div>
        <div style={{height:1,background:P.border,margin:"10px 0"}}/>
        <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Strateji</div>
        <Tog l="Manuel" v={man} set={setMan} tip="Sabit $ vs ATR otomatik."/>
        {man?<><Sld l="APTR $" v={mA} set={setMA} min={0.0005} max={8000} step={mA>100?10:mA>10?1:mA>1?0.1:0.001} tip="Katmanlar arasÄ± fark."/><Sld l="KÃ¢r $" v={mP} set={setMP} min={0.0005} max={4000} step={mP>50?5:mP>5?0.5:mP>0.5?0.05:0.0005} tip="KÃ¢r hedefi."/></>:<><Sld l="ATR" v={aL} set={setAL} min={5} max={50}/><Sld l="BÃ¶len" v={pD} set={setPD} min={1} max={5} step={0.5}/></>}
        <div style={{height:1,background:P.border,margin:"10px 0"}}/>
        <Tog l="EMA Filtre" v={eOn} set={setEOn}/><Tog l="RSI Ã‡Ä±kÄ±ÅŸ" v={rOn} set={setROn}/>{rOn&&<Sld l="RSI" v={rV} set={setRV} min={50} max={90}/>}
        {mkt==="crypto"&&bars&&<><div style={{height:1,background:P.border,margin:"10px 0"}}/>
        <div style={{fontFamily:Fm,fontSize:10,color:P.ember,letterSpacing:"0.12em",marginBottom:6,textTransform:"uppercase",fontWeight:600}}>ğŸ“¡ CANLI SÄ°NYAL</div>
        <label style={{display:"flex",alignItems:"center",gap:8,fontFamily:Fs,fontSize:11,color:P.ash,marginBottom:6,cursor:"pointer"}}><div onClick={()=>setSigOn(!sigOn)} style={{width:36,height:20,borderRadius:10,background:sigOn?P.jade:"#2A2D3A",position:"relative",flexShrink:0,transition:"0.25s"}}><div style={{width:16,height:16,borderRadius:8,background:P.white,position:"absolute",top:2,left:sigOn?18:2,transition:"0.25s"}}/></div>{sigOn?"Sinyal Aktif âœ…":"Sinyali AÃ§"}</label>
        {sigOn&&sig&&<div style={{fontFamily:Fm,fontSize:10,color:sig.signalColor,fontWeight:600}}>{sig.signal}{sig.alerts.length>0&&<span style={{color:P.danger,animation:"pulse 0.8s infinite"}}> â€¢ {sig.alerts.filter(a=>a.hot).length} yakÄ±n!</span>}</div>}</>}
        {bars&&<div style={{marginTop:12,padding:10,background:"rgba(123,92,245,0.05)",borderRadius:10,border:`1px solid ${P.border}`,fontFamily:Fm,fontSize:10}}><div style={{color:P.violet,fontWeight:600}}>{dN(sym)} â€¢ {tf}</div><div style={{color:P.ash}}>{bars.length} mum â€¢ {mkt==="crypto"?"OKX":"Yahoo"}</div></div>}
      </div>
      {/* MAIN */}
      <div style={{flex:1,padding:14,paddingBottom:200,overflowY:"auto"}}>
        {st==="loading"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:12}}><div style={{width:28,height:28,border:`3px solid ${P.violet}`,borderTopColor:"transparent",borderRadius:"50%",animation:"spin .7s linear infinite"}}/><span style={{fontFamily:Fs,fontSize:13,color:P.ash}}>{mkt==="crypto"?"OKX":"Yahoo"}'den veri Ã§ekiliyor...</span></div>}
        {sigOn&&sig&&mkt==="crypto"&&<SignalCard sig={sig} sym={sym} tf={tf}/>}
        {s&&st==="done"&&<>
          <div style={{display:"flex",flexWrap:"wrap",gap:7,marginBottom:12}}>
            <Stat l="Bakiye" v={s.fE} pre="$" color={rc}/><Stat l="Getiri" v={s.ret} suf="%" color={rc} pre={s.ret>=0?"+":""}/><Stat l="Kazanma" v={s.wr} suf="%" color={s.wr>=50?P.jade:P.danger}/><Stat l="Maks DD" v={s.mDD} suf="%" color={P.danger} pre="-"/><Stat l="PF" v={s.pf} color={s.pf>=1.5?P.jade:s.pf>=1?P.ember:P.danger}/><Stat l="Trade" v={s.cnt} color={P.cobalt}/><Stat l="Ort.Kat" v={s.aLy} color={P.violet}/>{s.oL>0&&<Stat l="âš AÃ§Ä±k" v={s.oL} color={P.ember}/>}
          </div>
          <div style={{display:"flex",gap:4,marginBottom:10,flexWrap:"wrap"}}>{[["candles","ğŸ•¯ Mum"],["equity","ğŸ“ˆ Bakiye"],["drawdown","ğŸ“‰ DD"],["trades","ğŸ“‹ Ä°ÅŸlem"]].map(([k,lb])=><button key={k} onClick={()=>setTab(k)} style={{fontFamily:Fs,fontSize:11,fontWeight:600,padding:"7px 14px",borderRadius:8,background:tab===k?"rgba(123,92,245,0.1)":"transparent",border:`1px solid ${tab===k?"rgba(123,92,245,0.4)":P.border}`,color:tab===k?P.violet:P.ash,cursor:"pointer"}}>{lb}</button>)}</div>
          <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,overflow:"hidden",marginBottom:12}}>
            {tab!=="trades"?<TVChart bars={bars} entries={res.entries} exits={res.exits} eqData={res.eqData} tab={tab}/>:
            <div style={{maxHeight:400,overflowY:"auto",padding:14}}><table style={{width:"100%",borderCollapse:"collapse",fontFamily:Fm,fontSize:11}}><thead><tr>{["#","Zaman","GiriÅŸ","Ã‡Ä±kÄ±ÅŸ","Kat","K/Z $","K/Z %","TÃ¼r"].map(h=><th key={h} style={{textAlign:"left",padding:"7px",color:P.ash,fontSize:10,borderBottom:`1px solid ${P.border}`,position:"sticky",top:0,background:P.card}}>{h}</th>)}</tr></thead><tbody>{res.trades.map((t,i)=><tr key={i} style={{borderBottom:`1px solid ${P.border}`}}><td style={{padding:"5px 7px",color:P.ash}}>{i+1}</td><td style={{padding:"5px 7px",fontSize:10}}>{(()=>{const d=new Date(t.time*1000);const isIntra=["15m","30m","1m","5m","1H","2H","4H","6H","12H"].includes(tf)||tf.includes("m")||tf.includes("h");return isIntra?d.toLocaleDateString("tr-TR",{month:"short",day:"numeric"})+" "+d.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"}):d.toLocaleDateString("tr-TR",{year:"numeric",month:"short",day:"numeric"});})()}</td><td style={{padding:"5px 7px"}}>${t.ae}</td><td style={{padding:"5px 7px"}}>${t.ex}</td><td style={{padding:"5px 7px",color:P.violet,fontWeight:600}}>{t.ly}</td><td style={{padding:"5px 7px",color:t.pnl>=0?P.jade:P.danger,fontWeight:600}}>{t.pnl>=0?"+":""}{t.pnl.toFixed(2)}</td><td style={{padding:"5px 7px",color:t.pp>=0?P.jade:P.danger}}>{t.pp>=0?"+":""}{t.pp}%</td><td style={{padding:"5px 7px"}}><span style={{background:t.rs==="TP"?P.jade+"18":P.ember+"18",color:t.rs==="TP"?P.jade:P.ember,padding:"2px 7px",borderRadius:4,fontSize:10,fontWeight:600}}>{t.rs==="TP"?"KÃ¢r":"RSI"}</span></td></tr>)}{!res.trades.length&&<tr><td colSpan={8} style={{padding:24,textAlign:"center",color:P.ash}}>Ä°ÅŸlem yok</td></tr>}</tbody></table></div>}
          </div>
          <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,padding:16}}><div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:10,fontWeight:600}}>Risk</div><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:6,fontFamily:Fm,fontSize:12}}><div><span style={{color:P.ash}}>En Ä°yi </span><span style={{color:P.jade}}>+${s.best}</span></div><div><span style={{color:P.ash}}>En KÃ¶tÃ¼ </span><span style={{color:P.danger}}>${s.worst}</span></div><div><span style={{color:P.ash}}>Ort W </span><span style={{color:P.jade}}>+${s.aW}</span></div><div><span style={{color:P.ash}}>Ort L </span><span style={{color:P.danger}}>${s.aL}</span></div><div style={{gridColumn:"span 2"}}><span style={{color:P.ash}}>SonuÃ§ </span><span style={{fontWeight:700,fontSize:13,color:s.ret>0&&s.mDD<25&&s.pf>1.2?P.jade:s.ret>0?P.ember:P.danger}}>{s.ret>0&&s.mDD<25&&s.pf>1.2?"âœ… Uygulanabilir":s.ret>0?"âš ï¸ Riskli":s.cnt===0?"â€”":"âŒ KÃ¢rsÄ±z"}</span></div></div></div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:"12px 0 4px"}}><img src={LOGO} width="16" height="16" style={{borderRadius:3}}/><span style={{fontFamily:Fs,fontSize:11,color:P.ash}}>Built by <span style={{color:P.white,fontWeight:600}}>BottomUP</span></span></div>
        </>}
        {st==="idle"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:10}}><img src={LOGO} width="48" height="48" style={{borderRadius:12}}/><span style={{fontFamily:Fd,fontSize:22,color:P.white}}>Press <span style={{color:P.violet}}>RUN</span></span><span style={{fontFamily:Fs,fontSize:12,color:P.ash}}>Market, sembol ve zaman dilimi seÃ§in</span></div>}
      </div>
    </div>
    {/* PAPER TRADING PANEL */}
    <PaperPanel engine={paperEng} setEngine={setPaperEng} syms={syms} cfg={cfg} tick={paperTick} setTick={setPaperTick}/>
  </div>;
}
ReactDOM.render(React.createElement(App),document.getElementById('root'));
</script>
</body>
</html>
