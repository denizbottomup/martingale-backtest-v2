<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Martingale V2 Backtest â€” BottomUP</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body,#root{height:100%;width:100%}
body{background:#13151C;color:#F3F4F6;font-family:'DM Sans',system-ui,sans-serif}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#13151C}::-webkit-scrollbar-thumb{background:#2A2D3A;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#7B5CF5}
input[type=range]{-webkit-appearance:none;background:rgba(123,92,245,0.15);border-radius:3px;outline:none;height:4px;width:100%}
input[type=range]:hover{background:rgba(123,92,245,0.25)}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#7B5CF5;cursor:pointer;box-shadow:0 0 8px rgba(123,92,245,0.4)}
select{background:#1A1D26;color:#F3F4F6;border:1px solid rgba(123,92,245,0.2);border-radius:8px;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;outline:none;cursor:pointer;transition:0.2s}
select:hover{border-color:rgba(123,92,245,0.4)}select:focus{border-color:#7B5CF5}
textarea{background:#0D0E14;color:#F3F4F6;border:1px solid rgba(123,92,245,0.2);border-radius:10px;padding:12px;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6;outline:none;resize:vertical;width:100%;tab-size:4}
textarea:focus{border-color:#7B5CF5;box-shadow:0 0 0 2px rgba(123,92,245,0.1)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.tip{position:relative;cursor:help;display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:rgba(123,92,245,0.15);color:#7B5CF5;font-size:9px;font-weight:700;margin-left:4px;flex-shrink:0}
.tip:hover .tiptext{display:block}
.tiptext{display:none;position:absolute;bottom:22px;left:50%;transform:translateX(-50%);background:#1E2130;border:1px solid rgba(123,92,245,0.25);border-radius:8px;padding:8px 10px;font-family:'DM Sans',sans-serif;font-size:11px;color:#F3F4F6;width:220px;z-index:999;line-height:1.4;font-weight:400;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef}=React;
const LWC=window.LightweightCharts;
const P={violet:"#7B5CF5",ember:"#F97316",jade:"#2DC771",danger:"#EF4444",cobalt:"#3B5BF5",ink:"#13151C",ash:"#6B7280",mist:"#F3F4F6",white:"#FFFFFF",card:"#1A1D26",surface:"#1E2130",border:"rgba(123,92,245,0.12)"};
const Fd="'Cormorant Display',Georgia,serif";const Fs="'DM Sans',system-ui,sans-serif";const Fm="'JetBrains Mono',monospace";
const LOGO="data:image/jpeg;base64,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";

// â”€â”€ Binance â”€â”€
async function fetchK(sym,intv,lim){const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${intv}&limit=${lim}`);if(!r.ok)throw new Error(`Binance API ${r.status}`);return(await r.json()).map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));}
// â”€â”€ Indicators â”€â”€
function _atr(b,x,len){if(x<1)return b[0].high-b[0].low;let s=0,n=0;for(let i=Math.max(1,x-len+1);i<=x;i++){s+=Math.max(b[i].high-b[i].low,Math.abs(b[i].high-b[i-1].close),Math.abs(b[i].low-b[i-1].close));n++;}return n?s/n:0;}
function _ema(b,x,len){const k=2/(len+1);let e=b[0].close;for(let i=1;i<=x;i++)e=b[i].close*k+e*(1-k);return e;}
function _rsi(b,x,len=14){if(x<len)return 50;let g=0,lo=0;for(let i=x-len+1;i<=x;i++){const d=b[i].close-b[i-1].close;if(d>0)g+=d;else lo-=d;}return lo===0?100:100-100/(1+g/lo);}
// â”€â”€ Backtest â”€â”€
function backtest(bars,cfg){const{al,man,mA,mP,aL,pD,rOn,rV,eOn,eL,cap}=cfg;const I=cap||10000;let cash=I,pos=[],trades=[],eqData=[],entries=[],exits=[];let peak=I,mDD=0;for(let i=1;i<bars.length;i++){const p=bars[i].close,a=_atr(bars,i,aL),e10=_ema(bars,i,eL||10),r=_rsi(bars,i);const fA=man?mA:a,fT=man?mP:a/pD,eS=eOn?p<e10:true,rO=rOn?r<rV:true;const pV=pos.reduce((s,x)=>s+x.q*p,0),curE=cash+pV;if(!pos.length&&eS&&rO){const amt=curE*(al[0]/100);if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:1});}}else if(pos.length>0&&pos.length<5){const lE=pos[pos.length-1].ep;if(p<lE-fA&&eS){const e2=cash+pos.reduce((s,x)=>s+x.q*p,0),amt=e2*(al[pos.length]/100);if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:pos.length});}}}if(pos.length>0){const tQ=pos.reduce((s,x)=>s+x.q,0),tC=pos.reduce((s,x)=>s+x.q*x.ep,0),aP=tC/tQ,rE=rOn&&r>rV;if(p>=aP+fT||rE){const eV=tQ*p,pnl=eV-tC;trades.push({bar:i,time:bars[i].time,ae:+aP.toFixed(2),ex:+p.toFixed(2),ly:pos.length,pnl:+pnl.toFixed(2),pp:+((pnl/tC)*100).toFixed(2),rs:rE?"RSI":"TP",at:+fA.toFixed(2)});exits.push({time:bars[i].time,price:p,reason:rE?"RSI":"TP",pnl:+pnl.toFixed(2)});cash+=eV;pos=[];}}const cE=cash+pos.reduce((s,x)=>s+x.q*p,0);if(cE>peak)peak=cE;const dd=((peak-cE)/peak)*100;if(dd>mDD)mDD=dd;eqData.push({time:bars[i].time,value:+cE.toFixed(2)});}const fE=cash+pos.reduce((s,x)=>s+x.q*bars[bars.length-1].close,0);const w=trades.filter(t=>t.pnl>0),lo=trades.filter(t=>t.pnl<=0);const gW=w.reduce((s,t)=>s+t.pnl,0),gL=Math.abs(lo.reduce((s,t)=>s+t.pnl,0));return{trades,eqData,entries,exits,s:{fE:+fE.toFixed(2),ret:+(((fE-I)/I)*100).toFixed(2),cnt:trades.length,wr:trades.length?+((w.length/trades.length)*100).toFixed(1):0,mDD:+mDD.toFixed(2),pf:gL>0?+(gW/gL).toFixed(2):w.length?999:0,aW:w.length?+(gW/w.length).toFixed(2):0,aL:lo.length?+(-gL/lo.length).toFixed(2):0,aLy:trades.length?+(trades.reduce((s,t)=>s+t.ly,0)/trades.length).toFixed(1):0,oL:pos.length,best:trades.length?+Math.max(...trades.map(t=>t.pnl)).toFixed(2):0,worst:trades.length?+Math.min(...trades.map(t=>t.pnl)).toFixed(2):0}};}

// â”€â”€ Pine Script Parser â”€â”€
function parsePineScript(code){
  const r={};const lines=code.split('\n');
  const num=(s)=>{const m=s.match(/-?[\d.]+/);return m?parseFloat(m[0]):null;};
  const str=(s)=>{const m=s.match(/["']([^"']+)["']/);return m?m[1]:null;};
  for(const line of lines){
    const l=line.trim();
    // strategy() call
    if(l.includes('strategy(')&&l.includes('initial_capital')){const ic=num(l.split('initial_capital')[1]);if(ic)r.initialCapital=ic;}
    // input() or input.int/float/bool
    const inpMatch=l.match(/(\w+)\s*=\s*input[\w.]*\(([^)]+)\)/);
    if(inpMatch){
      const varName=inpMatch[1].toLowerCase();const args=inpMatch[2];
      const defVal=num(args);const title=str(args);
      // Map known Pine Script variable patterns
      if(varName.includes('alloc')||varName.includes('pos1')||title?.toLowerCase().includes('pos 1'))r.layer1=defVal;
      if(varName.includes('pos2')||title?.toLowerCase().includes('pos 2'))r.layer2=defVal;
      if(varName.includes('pos3')||title?.toLowerCase().includes('pos 3'))r.layer3=defVal;
      if(varName.includes('pos4')||title?.toLowerCase().includes('pos 4'))r.layer4=defVal;
      if(varName.includes('pos5')||title?.toLowerCase().includes('pos 5'))r.layer5=defVal;
      if(varName.includes('aptr')||varName.includes('drop')||title?.toLowerCase().includes('aptr'))r.aptr=defVal;
      if(varName.includes('profit')||varName.includes('target')||title?.toLowerCase().includes('profit'))r.profitTarget=defVal;
      if(varName.includes('atr_len')||varName.includes('atrlen'))r.atrLength=defVal;
      if(varName.includes('rsi_level')||varName.includes('rsilevel')||varName.includes('rsi_exit'))r.rsiLevel=defVal;
      if(varName.includes('ema_len')||varName.includes('emalen'))r.emaLength=defVal;
      if(varName.includes('use_ema')||varName.includes('useema'))r.useEma=l.includes('true');
      if(varName.includes('use_rsi')||varName.includes('usersi'))r.useRsi=l.includes('true');
      if(varName.includes('manual')||varName.includes('use_manual'))r.useManual=l.includes('true');
      if(varName.includes('profit_div')||varName.includes('profitdiv'))r.profitDivisor=defVal;
    }
    // Direct assignments: var = value
    if(!l.startsWith('//')&&l.includes('=')&&!l.includes('input')){
      const assign=l.match(/(\w+)\s*=\s*(-?[\d.]+)/);
      if(assign){
        const v=assign[1].toLowerCase(),val=parseFloat(assign[2]);
        if(v.includes('initial_capital'))r.initialCapital=val;
      }
    }
  }
  return r;
}

function mergeStrategy(current,parsed){
  const next=JSON.parse(JSON.stringify(current));
  if(parsed.initialCapital)next.defaults.initialCapital=parsed.initialCapital;
  if(parsed.useManual!==undefined)next.defaults.useManual=parsed.useManual;
  if(parsed.useEma!==undefined)next.defaults.useEma=parsed.useEma;
  if(parsed.useRsi!==undefined)next.defaults.useRsi=parsed.useRsi;
  if(parsed.rsiLevel)next.defaults.rsiLevel=parsed.rsiLevel;
  if(parsed.atrLength)next.defaults.atrLength=parsed.atrLength;
  if(parsed.emaLength)next.defaults.emaLength=parsed.emaLength;
  if(parsed.profitDivisor)next.defaults.profitDivisor=parsed.profitDivisor;
  if(parsed.layer1)next.allocations.layer1=parsed.layer1;
  if(parsed.layer2)next.allocations.layer2=parsed.layer2;
  if(parsed.layer3)next.allocations.layer3=parsed.layer3;
  if(parsed.layer4)next.allocations.layer4=parsed.layer4;
  if(parsed.layer5)next.allocations.layer5=parsed.layer5;
  // Increment version
  const v=parseFloat(next._version||"2.1");
  next._version=(v+0.1).toFixed(1);
  return next;
}

// â”€â”€ TradingView Chart â”€â”€
function TVChart({bars,entries,exits,eqData,tab}){const ref=useRef(null),chartRef=useRef(null);useEffect(()=>{if(!ref.current||!LWC)return;if(chartRef.current){try{chartRef.current.remove();}catch{}}ref.current.innerHTML='';const chart=LWC.createChart(ref.current,{width:ref.current.clientWidth,height:400,layout:{background:{type:'solid',color:P.card},textColor:P.ash,fontFamily:Fm,fontSize:11},grid:{vertLines:{color:'rgba(123,92,245,0.06)'},horzLines:{color:'rgba(123,92,245,0.06)'}},crosshair:{mode:0,vertLine:{color:P.violet+'44',width:1,style:2,labelBackgroundColor:P.violet},horzLine:{color:P.violet+'44',width:1,style:2,labelBackgroundColor:P.violet}},rightPriceScale:{borderColor:P.border},timeScale:{borderColor:P.border,timeVisible:true,secondsVisible:false},handleScroll:true,handleScale:true});chartRef.current=chart;if(tab==="candles"&&bars?.length){const cs=chart.addCandlestickSeries({upColor:P.jade,downColor:P.danger,borderUpColor:P.jade,borderDownColor:P.danger,wickUpColor:P.jade+'99',wickDownColor:P.danger+'99'});cs.setData(bars);const vs=chart.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:'vol',color:P.violet+'22'});chart.priceScale('vol').applyOptions({scaleMargins:{top:0.85,bottom:0}});vs.setData(bars.map(b=>({time:b.time,value:b.volume,color:b.close>=b.open?P.jade+'33':P.danger+'33'})));if(entries?.length||exits?.length){const mk=[...(entries||[]).map(e=>({time:e.time,position:'belowBar',color:P.jade,shape:'arrowUp',text:`B${e.layer}`})),...(exits||[]).map(x=>({time:x.time,position:'aboveBar',color:x.pnl>=0?P.jade:P.danger,shape:'arrowDown',text:`${x.reason} ${x.pnl>=0?'+':''}$${x.pnl.toFixed(0)}`}))].sort((a,b)=>a.time-b.time);cs.setMarkers(mk);}}if(tab==="equity"&&eqData?.length){const es=chart.addAreaSeries({topColor:P.violet+'33',bottomColor:P.violet+'05',lineColor:P.violet,lineWidth:2,priceFormat:{type:'custom',formatter:v=>'$'+v.toFixed(0)}});es.setData(eqData);const rs=chart.addLineSeries({color:P.ash+'44',lineWidth:1,lineStyle:2,priceFormat:{type:'custom',formatter:()=>''}});rs.setData(eqData.map(d=>({time:d.time,value:10000})));}if(tab==="drawdown"&&eqData?.length){let pk=10000;const dd=eqData.map(d=>{if(d.value>pk)pk=d.value;return{time:d.time,value:+((pk-d.value)/pk*100).toFixed(2)};});const ds=chart.addAreaSeries({topColor:P.danger+'33',bottomColor:P.danger+'05',lineColor:P.danger,lineWidth:2,invertFilledArea:true,priceFormat:{type:'custom',formatter:v=>v.toFixed(1)+'%'}});ds.setData(dd);}chart.timeScale().fitContent();const ro=new ResizeObserver(()=>{if(ref.current)chart.applyOptions({width:ref.current.clientWidth});});ro.observe(ref.current);return()=>{ro.disconnect();try{chart.remove();}catch{};};},[bars,entries,exits,eqData,tab]);return <div ref={ref} style={{width:"100%",borderRadius:12,overflow:"hidden"}}/>;}

// â”€â”€ UI Atoms â”€â”€
const Tip=({text})=><span className="tip">?<span className="tiptext">{text}</span></span>;
const Stat=({l,v,color,pre="",suf="",tip})=>(<div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:12,padding:"12px 14px",flex:"1 1 120px",minWidth:105,animation:"fadeIn 0.3s"}}><div style={{fontFamily:Fm,fontSize:9,color:P.ash,letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:6,display:"flex",alignItems:"center"}}>{l}{tip&&<Tip text={tip}/>}</div><div style={{fontFamily:Fm,fontSize:16,fontWeight:600,color:color||P.mist}}>{pre}{typeof v==="number"?v.toLocaleString("en",{maximumFractionDigits:2}):v}{suf}</div></div>);
const Sld=({l,v,set,min,max,step=1,suf="",tip})=>(<div style={{marginBottom:10}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}><span style={{fontFamily:Fs,fontSize:11,color:P.ash,fontWeight:500,display:"flex",alignItems:"center"}}>{l}{tip&&<Tip text={tip}/>}</span><span style={{fontFamily:Fm,fontSize:11,color:P.violet,fontWeight:600}}>{v}{suf}</span></div><input type="range" min={min} max={max} step={step} value={v} onChange={e=>set(+e.target.value)}/></div>);
const Tog=({l,v,set,tip})=>(<label style={{display:"flex",alignItems:"center",gap:8,fontFamily:Fs,fontSize:11,color:P.ash,marginBottom:8,cursor:"pointer",fontWeight:500}}><div onClick={()=>set(!v)} style={{width:36,height:20,borderRadius:10,background:v?P.violet:"#2A2D3A",position:"relative",flexShrink:0,transition:"0.25s",boxShadow:v?`0 0 10px ${P.violet}33`:"none"}}><div style={{width:16,height:16,borderRadius:8,background:P.white,position:"absolute",top:2,left:v?18:2,transition:"0.25s"}}/></div>{l}{tip&&<Tip text={tip}/>}</label>);

// â”€â”€ Onboarding â”€â”€
function Onboarding({onClose}){const[step,setStep]=useState(0);const steps=[{title:"HoÅŸ geldiniz! ğŸ‘‹",body:"Bu araÃ§, TradingView Pine Script'teki Martingale V2 stratejisini gerÃ§ek Binance verileriyle test etmenizi saÄŸlar.",icon:"ğŸ¯"},{title:"Strateji NasÄ±l Ã‡alÄ±ÅŸÄ±r?",body:"Fiyat dÃ¼ÅŸtÃ¼kÃ§e kademe kademe alÄ±m yapar (5 katmana kadar). Fiyat ortalama giriÅŸin Ã¼zerine Ã§Ä±kÄ±nca tÃ¼m pozisyonlarÄ± kÃ¢rla kapatÄ±r.\n\nMartingale: \"DÃ¼ÅŸtÃ¼kÃ§e al, ortalamayÄ± dÃ¼ÅŸÃ¼r.\"",icon:"ğŸ“Š"},{title:"Sol Panel: Ayarlar",body:"â€¢ Allocation: Her katmanÄ±n sermaye %'si\nâ€¢ APTR: Katmanlar arasÄ± fiyat farkÄ± ($)\nâ€¢ Profit Target: KÃ¢r hedefi ($)\nâ€¢ EMA Filter: Fiyat<EMA iken alÄ±r\nâ€¢ RSI Exit: RSI>71 olunca erken Ã§Ä±kÄ±ÅŸ",icon:"âš™ï¸"},{title:"Grafik & SonuÃ§lar",body:"â€¢ ğŸ•¯ Mum grafiÄŸi + alÄ±m/satÄ±m oklarÄ±\nâ€¢ ğŸ“ˆ Bakiye eÄŸrisi\nâ€¢ ğŸ“‰ DÃ¼ÅŸÃ¼ÅŸ grafiÄŸi\nâ€¢ ğŸ“‹ TÃ¼m iÅŸlemlerin detayÄ±\n\nZoom/pan yapabilirsiniz.",icon:"ğŸ“ˆ"},{title:"ğŸ§‘â€ğŸ’» Pine Script Konsolu",body:"SaÄŸ Ã¼stteki </> butonuna basarak Pine Script kodunuzu yapÄ±ÅŸtÄ±rabilirsiniz. Kod otomatik parse edilir, parametreler gÃ¼ncellenir.\n\nHata olursa \"Geri Al\" ile Ã¶nceki versiyona dÃ¶nebilirsiniz.",icon:"ğŸ’»"}];const s=steps[step];return(<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeIn 0.3s"}}><div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:20,padding:32,maxWidth:480,width:"90%",animation:"slideUp 0.4s"}}><div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}><img src={LOGO} width="28" height="28" style={{borderRadius:6}}/><span style={{fontFamily:Fs,fontSize:13,color:P.ash}}>BottomUP Backtester</span><span style={{marginLeft:"auto",fontFamily:Fm,fontSize:10,color:P.ash}}>{step+1}/{steps.length}</span></div><div style={{fontSize:36,marginBottom:12}}>{s.icon}</div><h2 style={{fontFamily:Fd,fontSize:24,color:P.white,marginBottom:10}}>{s.title}</h2><p style={{fontFamily:Fs,fontSize:13,color:P.mist,lineHeight:1.7,whiteSpace:"pre-line",marginBottom:20}}>{s.body}</p><div style={{display:"flex",gap:8,justifyContent:"space-between"}}><button onClick={onClose} style={{fontFamily:Fs,fontSize:12,padding:"8px 16px",borderRadius:8,background:"transparent",border:`1px solid ${P.border}`,color:P.ash,cursor:"pointer"}}>Atla</button><div style={{display:"flex",gap:6}}>{step>0&&<button onClick={()=>setStep(step-1)} style={{fontFamily:Fs,fontSize:12,padding:"8px 16px",borderRadius:8,background:P.surface,border:"none",color:P.mist,cursor:"pointer"}}>â† Geri</button>}{step<steps.length-1?<button onClick={()=>setStep(step+1)} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:P.violet,border:"none",color:P.white,cursor:"pointer"}}>Ä°leri â†’</button>:<button onClick={onClose} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:P.jade,border:"none",color:P.white,cursor:"pointer"}}>BaÅŸla! ğŸš€</button>}</div></div><div style={{display:"flex",gap:4,justifyContent:"center",marginTop:16}}>{steps.map((_,i)=><div key={i} style={{width:i===step?20:6,height:6,borderRadius:3,background:i===step?P.violet:P.ash+"44",transition:"0.3s"}}/>)}</div></div></div>);}

// â”€â”€ Dev Console â”€â”€
function DevConsole({open,onClose,cfg,onApply}){
  const[code,setCode]=useState('');
  const[parsed,setParsed]=useState(null);
  const[parseErr,setParseErr]=useState(null);
  const[saving,setSaving]=useState(false);
  const[saved,setSaved]=useState(false);
  const[history,setHistory]=useState([]);
  const[loadingHist,setLoadingHist]=useState(false);
  const[rollingBack,setRollingBack]=useState(false);

  useEffect(()=>{if(open){setLoadingHist(true);fetch('/api/strategy/history').then(r=>r.json()).then(h=>{setHistory(h);setLoadingHist(false);}).catch(()=>setLoadingHist(false));}},[open]);

  const handleParse=()=>{
    try{
      setParseErr(null);setSaved(false);
      const p=parsePineScript(code);
      if(Object.keys(p).length===0){setParseErr("âš  Pine Script'ten hiÃ§bir parametre Ã§Ä±karÄ±lamadÄ±. input() satÄ±rlarÄ± olduÄŸundan emin olun.");return;}
      setParsed(p);
    }catch(e){setParseErr("Parse hatasÄ±: "+e.message);}
  };

  const handleApply=async()=>{
    if(!parsed||!cfg)return;
    setSaving(true);
    try{
      const merged=mergeStrategy(cfg,parsed);
      const r=await fetch('/api/strategy',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(merged)});
      if(!r.ok)throw new Error('Save failed');
      setSaved(true);setParsed(null);setCode('');
      onApply(merged);
      // Refresh history
      const h=await(await fetch('/api/strategy/history')).json();setHistory(h);
    }catch(e){setParseErr("Kaydetme hatasÄ±: "+e.message);}
    setSaving(false);
  };

  const handleRollback=async(filename)=>{
    setRollingBack(true);
    try{
      const r=await fetch('/api/strategy/rollback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename})});
      if(!r.ok)throw new Error('Rollback failed');
      const newCfg=await(await fetch('/api/strategy')).json();
      onApply(newCfg);
      const h=await(await fetch('/api/strategy/history')).json();setHistory(h);
      setSaved(false);setParsed(null);
    }catch(e){setParseErr("Geri alma hatasÄ±: "+e.message);}
    setRollingBack(false);
  };

  if(!open)return null;
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.8)",zIndex:9998,display:"flex",alignItems:"center",justifyContent:"center",animation:"fadeIn 0.2s"}}>
      <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:16,width:"90%",maxWidth:700,maxHeight:"90vh",overflow:"hidden",display:"flex",flexDirection:"column",animation:"slideUp 0.3s"}}>
        {/* Header */}
        <div style={{padding:"16px 20px",borderBottom:`1px solid ${P.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <span style={{fontSize:18}}>ğŸ§‘â€ğŸ’»</span>
            <div>
              <h2 style={{fontFamily:Fd,fontSize:20,color:P.white}}>Pine Script <span style={{color:P.violet}}>Konsol</span></h2>
              <p style={{fontFamily:Fm,fontSize:9,color:P.ash}}>Kodu yapÄ±ÅŸtÄ±r â†’ Parse et â†’ Uygula</p>
            </div>
          </div>
          <button onClick={onClose} style={{fontFamily:Fs,fontSize:18,background:"transparent",border:"none",color:P.ash,cursor:"pointer",padding:4}}>âœ•</button>
        </div>

        <div style={{padding:20,overflowY:"auto",flex:1}}>
          {/* Code Input */}
          <div style={{marginBottom:16}}>
            <label style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.1em",textTransform:"uppercase",display:"block",marginBottom:6}}>Pine Script Kodu</label>
            <textarea value={code} onChange={e=>setCode(e.target.value)} rows={10} placeholder={`// Pine Script kodunu buraya yapÄ±ÅŸtÄ±rÄ±n\n// Ã–rnek:\npos1_alloc = input.float(10, "Pos 1 Allocation %")\naptr = input.float(80, "APTR Drop $")\nprofit_target = input.float(40, "Profit Target $")\nuse_ema = input.bool(true, "Use EMA Filter")`} style={{minHeight:180}}/>
            <div style={{display:"flex",gap:8,marginTop:8}}>
              <button onClick={handleParse} disabled={!code.trim()} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:code.trim()?P.violet:P.surface,border:"none",color:P.white,cursor:code.trim()?"pointer":"not-allowed",transition:"0.2s"}}>ğŸ” Parse Et</button>
              {parsed&&<button onClick={handleApply} disabled={saving} style={{fontFamily:Fs,fontSize:12,fontWeight:600,padding:"8px 20px",borderRadius:8,background:saving?P.surface:P.jade,border:"none",color:P.white,cursor:saving?"wait":"pointer"}}>{saving?"â³ Kaydediliyor...":"âœ… Uygula & Kaydet"}</button>}
            </div>
          </div>

          {/* Parse Results */}
          {parseErr&&<div style={{padding:"10px 14px",background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.25)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.danger,marginBottom:12}}>{parseErr}</div>}
          {saved&&<div style={{padding:"10px 14px",background:"rgba(45,199,113,0.1)",border:"1px solid rgba(45,199,113,0.25)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.jade,marginBottom:12}}>âœ… Strateji gÃ¼ncellendi! Backtest'i tekrar RUN edin.</div>}

          {parsed&&!saved&&(
            <div style={{background:P.surface,borderRadius:10,padding:14,marginBottom:16,border:`1px solid ${P.border}`}}>
              <div style={{fontFamily:Fm,fontSize:10,color:P.ember,letterSpacing:"0.1em",marginBottom:8,fontWeight:600}}>ğŸ“‹ PARSE EDÄ°LEN PARAMETRELER</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,fontFamily:Fm,fontSize:12}}>
                {Object.entries(parsed).map(([k,v])=>(
                  <div key={k} style={{display:"flex",justifyContent:"space-between",padding:"4px 8px",background:P.card,borderRadius:6}}>
                    <span style={{color:P.ash}}>{k}</span>
                    <span style={{color:P.violet,fontWeight:600}}>{String(v)}</span>
                  </div>
                ))}
              </div>
              <p style={{fontFamily:Fs,fontSize:11,color:P.ember,marginTop:8}}>âš  "Uygula & Kaydet"e basÄ±nca mevcut strategy.json gÃ¼ncellenir. Ã–nceki versiyon otomatik yedeklenir.</p>
            </div>
          )}

          {/* Version History */}
          <div style={{borderTop:`1px solid ${P.border}`,paddingTop:14}}>
            <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.1em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>ğŸ“¦ Versiyon GeÃ§miÅŸi</div>
            {loadingHist?<div style={{fontFamily:Fm,fontSize:11,color:P.ash}}>YÃ¼kleniyor...</div>:
            history.length===0?<div style={{fontFamily:Fm,fontSize:11,color:P.ash}}>HenÃ¼z geÃ§miÅŸ yok. Ä°lk gÃ¼ncellemenizden sonra burada gÃ¶rÃ¼necek.</div>:
            <div style={{maxHeight:200,overflowY:"auto"}}>
              {history.map((h,i)=>(
                <div key={i} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 10px",background:i%2===0?P.card:"transparent",borderRadius:6,marginBottom:2}}>
                  <div>
                    <span style={{fontFamily:Fm,fontSize:11,color:P.mist}}>v{h.version}</span>
                    <span style={{fontFamily:Fm,fontSize:10,color:P.ash,marginLeft:8}}>{new Date(h.date).toLocaleString("tr-TR",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}</span>
                    {h.filename.includes('rollback')&&<span style={{fontFamily:Fm,fontSize:9,color:P.ember,marginLeft:6}}>â†© rollback</span>}
                  </div>
                  <button onClick={()=>handleRollback(h.filename)} disabled={rollingBack} style={{fontFamily:Fs,fontSize:10,fontWeight:600,padding:"4px 12px",borderRadius:6,background:"rgba(249,115,22,0.1)",border:"1px solid rgba(249,115,22,0.25)",color:P.ember,cursor:rollingBack?"wait":"pointer"}}>{rollingBack?"â³":"â†© Geri Al"}</button>
                </div>
              ))}
            </div>}
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ MAIN â”€â”€
function App(){
  const[cfg,setCfg]=useState(null);const[showTut,setShowTut]=useState(true);const[showDev,setShowDev]=useState(false);
  const[sym,setSym]=useState("ETHUSDT");const[tf,setTf]=useState("1h");
  const[a1,sA1]=useState(10);const[a2,sA2]=useState(15);const[a3,sA3]=useState(20);const[a4,sA4]=useState(25);const[a5,sA5]=useState(30);
  const[man,setMan]=useState(true);const[mA,setMA]=useState(80);const[mP,setMP]=useState(40);
  const[aL,setAL]=useState(14);const[pD,setPD]=useState(2);
  const[rOn,setROn]=useState(false);const[rV,setRV]=useState(71);const[eOn,setEOn]=useState(true);
  const[res,setRes]=useState(null);const[bars,setBars]=useState(null);
  const[tab,setTab]=useState("candles");const[st,setSt]=useState("idle");
  const[lP,setLP]=useState(null);const[err,setErr]=useState(null);const ws=useRef(null);

  const applyCfg=useCallback((c)=>{
    setCfg(c);
    if(c.defaults){setSym(c.defaults.symbol||"ETHUSDT");setTf(c.defaults.timeframe||"1h");setMan(c.defaults.useManual!==false);setEOn(c.defaults.useEma!==false);setROn(c.defaults.useRsi===true);setRV(c.defaults.rsiLevel||71);setAL(c.defaults.atrLength||14);setPD(c.defaults.profitDivisor||2);}
    if(c.allocations){sA1(c.allocations.layer1||10);sA2(c.allocations.layer2||15);sA3(c.allocations.layer3||20);sA4(c.allocations.layer4||25);sA5(c.allocations.layer5||30);}
  },[]);

  useEffect(()=>{fetch('/api/strategy').then(r=>r.json()).then(c=>applyCfg(c)).catch(()=>{});},[applyCfg]);

  const getSmartDef=useCallback((s,t)=>{if(!man||!cfg)return;const m={"15m":0,"1h":1,"4h":2,"1d":3,"1w":4}[t]||1;const sd=cfg.smartDefaults||{};const sg=cfg.symbolGroups||{};let grp="OTHER";if(s.startsWith("BTC"))grp="BTC";else if(s.startsWith("ETH"))grp="ETH";else if(s.startsWith("BNB"))grp="BNB";else if((sg.MID||[]).includes(s))grp="MID";else if((sg.LOW||[]).includes(s))grp="LOW";const d=sd[grp]||sd["OTHER"]||{aptr:[1,3,10,25,60],profit:[0.5,1.5,5,12,30]};setMA(d.aptr[m]);setMP(d.profit[m]);},[man,cfg]);

  const run=useCallback(async()=>{setSt("loading");setErr(null);try{const tfObj=(cfg?.timeframes||[{value:"1h",limit:500}]).find(t=>t.value===tf);const d=await fetchK(sym,tf,tfObj?.limit||500);setBars(d);setRes(backtest(d,{al:[a1,a2,a3,a4,a5],man,mA,mP,aL,pD,rOn,rV,eOn,eL:cfg?.defaults?.emaLength||10,cap:cfg?.defaults?.initialCapital||10000}));setSt("done");}catch(e){setErr(e.message);setSt("error");}},[sym,tf,a1,a2,a3,a4,a5,man,mA,mP,aL,pD,rOn,rV,eOn,cfg]);

  useEffect(()=>{if(ws.current)ws.current.close();setLP(null);try{const w=new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@trade`);w.onmessage=e=>{try{setLP(+parseFloat(JSON.parse(e.data).p).toFixed(4));}catch{}};ws.current=w;}catch{}return()=>{if(ws.current)ws.current.close();};},[sym]);
  useEffect(()=>{run();},[]);

  const s=res?.s;const rc=s?(s.ret>=0?P.jade:P.danger):P.mist;const aT=a1+a2+a3+a4+a5;
  const syms=cfg?.symbols||["BTCUSDT","ETHUSDT","SOLUSDT"];const tfs=cfg?.timeframes||[{label:"1h",value:"1h"}];

  return(
    <div style={{minHeight:"100vh",background:P.ink,color:P.mist,fontFamily:Fs}}>
      {showTut&&<Onboarding onClose={()=>setShowTut(false)}/>}
      <DevConsole open={showDev} onClose={()=>setShowDev(false)} cfg={cfg} onApply={(c)=>{applyCfg(c);setShowDev(false);}}/>

      {/* HEADER */}
      <div style={{padding:"10px 18px",borderBottom:`1px solid ${P.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:8,background:`linear-gradient(180deg,${P.card},${P.ink})`}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <img src={LOGO} width="30" height="30" style={{borderRadius:8}}/>
          <div><h1 style={{fontFamily:Fd,fontSize:20,fontWeight:700,color:P.white}}>Martingale <span style={{color:P.violet}}>V2</span></h1><p style={{fontFamily:Fm,fontSize:8,color:P.ash,letterSpacing:"0.08em"}}>BINANCE â€¢ TRADINGVIEW â€¢ v{cfg?._version||"2.1"}</p></div>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
          {lP&&<div style={{fontFamily:Fm,fontSize:13,color:P.jade,display:"flex",alignItems:"center",gap:5,fontWeight:600}}><div style={{width:7,height:7,borderRadius:4,background:P.jade,animation:"pulse 2s infinite",boxShadow:`0 0 8px ${P.jade}66`}}/>${lP.toLocaleString("en")}</div>}
          <select value={sym} onChange={e=>{setSym(e.target.value);getSmartDef(e.target.value,tf);}}>{syms.map(s=><option key={s} value={s}>{s.replace("USDT","/USDT")}</option>)}</select>
          <select value={tf} onChange={e=>{setTf(e.target.value);getSmartDef(sym,e.target.value);}}>{tfs.map(t=><option key={t.value} value={t.value}>{t.label}</option>)}</select>
          <button onClick={run} disabled={st==="loading"} style={{fontFamily:Fs,fontSize:12,fontWeight:700,padding:"7px 18px",borderRadius:10,background:st==="loading"?"#2A2D3A":`linear-gradient(135deg,${P.violet},${P.cobalt})`,border:"none",color:P.white,cursor:st==="loading"?"wait":"pointer",boxShadow:st==="loading"?"none":`0 4px 20px ${P.violet}40`,transition:"0.2s"}}>{st==="loading"?"â³":"â–¶ RUN"}</button>
          <button onClick={()=>setShowDev(true)} style={{fontFamily:Fm,fontSize:11,padding:"7px 12px",borderRadius:8,background:"rgba(249,115,22,0.1)",border:"1px solid rgba(249,115,22,0.25)",color:P.ember,cursor:"pointer",fontWeight:600}} title="Pine Script Konsol">&lt;/&gt;</button>
          <button onClick={()=>setShowTut(true)} style={{fontFamily:Fs,fontSize:11,padding:"7px 10px",borderRadius:8,background:"transparent",border:`1px solid ${P.border}`,color:P.ash,cursor:"pointer"}} title="YardÄ±m">â“</button>
        </div>
      </div>

      {err&&<div style={{margin:"8px 18px",padding:"10px 14px",background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.danger}}>âš  {err}</div>}

      <div style={{display:"flex",height:"calc(100vh - 56px)"}}>
        {/* SIDEBAR */}
        <div style={{width:250,minWidth:250,borderRight:`1px solid ${P.border}`,padding:"14px 12px",overflowY:"auto",background:P.card+"88"}}>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Allocation</div>
          <Sld l="Katman 1" v={a1} set={sA1} min={1} max={50} suf="%" tip="Ä°lk alÄ±m. Fiyat EMA altÄ±na dÃ¼ÅŸÃ¼nce toplam sermayenin bu yÃ¼zdesiyle giriÅŸ yapÄ±lÄ±r."/>
          <Sld l="Katman 2" v={a2} set={sA2} min={1} max={50} suf="%" tip="Fiyat APTR kadar dÃ¼ÅŸerse aÃ§Ä±lan 2. pozisyon."/>
          <Sld l="Katman 3" v={a3} set={sA3} min={1} max={50} suf="%" tip="3. dÃ¼ÅŸÃ¼ÅŸte aÃ§Ä±lan pozisyon."/>
          <Sld l="Katman 4" v={a4} set={sA4} min={1} max={50} suf="%" tip="4. kademe alÄ±m."/>
          <Sld l="Katman 5" v={a5} set={sA5} min={1} max={50} suf="%" tip="Son katman. âš  Daha dÃ¼ÅŸerse stop-loss yok!"/>
          <div style={{fontFamily:Fm,fontSize:11,color:aT===100?P.jade:P.ember,marginBottom:4,fontWeight:600}}>Toplam: {aT}%{aT!==100&&" âš  (100 olmalÄ±)"}</div>
          <div style={{height:1,background:P.border,margin:"10px 0"}}/>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Strateji</div>
          <Tog l="Manuel Mod" v={man} set={setMan} tip="AÃ§Ä±k: Sabit $ deÄŸerler. KapalÄ±: ATR otomatik."/>
          {man?(<><Sld l="APTR (DÃ¼ÅŸÃ¼ÅŸ $)" v={mA} set={setMA} min={0.0005} max={8000} step={mA>100?10:mA>10?1:mA>1?0.1:0.001} tip="Katmanlar arasÄ± fiyat farkÄ± ($)."/><Sld l="KÃ¢r Hedefi $" v={mP} set={setMP} min={0.0005} max={4000} step={mP>50?5:mP>5?0.5:mP>0.5?0.05:0.0005} tip="Ortalama giriÅŸin kaÃ§ $ Ã¼stÃ¼nde kÃ¢r alÄ±nÄ±r."/></>):(<><Sld l="ATR Uzunluk" v={aL} set={setAL} min={5} max={50} tip="ATR hesaplama periyodu."/><Sld l="KÃ¢r BÃ¶leni" v={pD} set={setPD} min={1} max={5} step={0.5} tip="KÃ¢r hedefi = ATR / bu deÄŸer."/></>)}
          <div style={{height:1,background:P.border,margin:"10px 0"}}/>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Filtreler</div>
          <Tog l="EMA Filtre" v={eOn} set={setEOn} tip="Sadece fiyat EMA altÄ±ndayken alÄ±r."/>
          <Tog l="RSI Ã‡Ä±kÄ±ÅŸ" v={rOn} set={setROn} tip="RSI aÅŸÄ±rÄ± alÄ±m bÃ¶lgesinde erken Ã§Ä±kÄ±ÅŸ."/>
          {rOn&&<Sld l="RSI Seviye" v={rV} set={setRV} min={50} max={90} tip="Bu RSI Ã¼stÃ¼nde pozisyon kapatÄ±lÄ±r."/>}
          {bars&&<div style={{marginTop:12,padding:10,background:"rgba(123,92,245,0.05)",borderRadius:10,border:`1px solid ${P.border}`,fontFamily:Fm,fontSize:10}}><div style={{color:P.violet,marginBottom:4,fontWeight:600}}>{sym.replace("USDT","/USDT")} â€¢ {tf}</div><div style={{color:P.ash}}>{bars.length} mum</div></div>}
        </div>

        {/* MAIN */}
        <div style={{flex:1,padding:14,overflowY:"auto"}}>
          {st==="loading"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:12}}><div style={{width:28,height:28,border:`3px solid ${P.violet}`,borderTopColor:"transparent",borderRadius:"50%",animation:"spin .7s linear infinite"}}/><span style={{fontFamily:Fs,fontSize:13,color:P.ash}}>Binance'den veri Ã§ekiliyor...</span></div>}
          {s&&st==="done"&&(<>
            <div style={{display:"flex",flexWrap:"wrap",gap:7,marginBottom:12}}>
              <Stat l="Son Bakiye" v={s.fE} pre="$" color={rc} tip="$10K baÅŸlangÄ±Ã§ sermayesi ile backtest sonucu."/>
              <Stat l="Getiri" v={s.ret} suf="%" color={rc} pre={s.ret>=0?"+":""} tip="Toplam kÃ¢r/zarar yÃ¼zdesi."/>
              <Stat l="Kazanma" v={s.wr} suf="%" color={s.wr>=50?P.jade:P.danger} tip="KÃ¢rlÄ± trade oranÄ±. >%50 iyi."/>
              <Stat l="Maks DD" v={s.mDD} suf="%" color={P.danger} pre="-" tip="En kÃ¶tÃ¼ dÃ¼ÅŸÃ¼ÅŸ. <%25 kabul edilebilir."/>
              <Stat l="KÃ¢r Fak." v={s.pf} color={s.pf>=1.5?P.jade:s.pf>=1?P.ember:P.danger} tip="Toplam kÃ¢r / zarar. >1.5 iyi."/>
              <Stat l="Trade" v={s.cnt} color={P.cobalt}/>
              <Stat l="Ort. Kat." v={s.aLy} color={P.violet} tip="Ortalama katman sayÄ±sÄ±."/>
              {s.oL>0&&<Stat l="âš  AÃ§Ä±k" v={s.oL} suf=" kat." color={P.ember}/>}
            </div>
            <div style={{display:"flex",gap:4,marginBottom:10,flexWrap:"wrap"}}>{[["candles","ğŸ•¯ Mum"],["equity","ğŸ“ˆ Bakiye"],["drawdown","ğŸ“‰ DÃ¼ÅŸÃ¼ÅŸ"],["trades","ğŸ“‹ Ä°ÅŸlemler"]].map(([k,lb])=>(<button key={k} onClick={()=>setTab(k)} style={{fontFamily:Fs,fontSize:11,fontWeight:600,padding:"7px 16px",borderRadius:8,background:tab===k?"rgba(123,92,245,0.1)":"transparent",border:`1px solid ${tab===k?"rgba(123,92,245,0.4)":P.border}`,color:tab===k?P.violet:P.ash,cursor:"pointer",transition:"0.2s"}}>{lb}</button>))}</div>
            <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,overflow:"hidden",marginBottom:12}}>
              {tab!=="trades"?<TVChart bars={bars} entries={res.entries} exits={res.exits} eqData={res.eqData} tab={tab}/>:(<div style={{maxHeight:400,overflowY:"auto",padding:14}}><table style={{width:"100%",borderCollapse:"collapse",fontFamily:Fm,fontSize:11}}><thead><tr>{["#","Zaman","GiriÅŸ","Ã‡Ä±kÄ±ÅŸ","Kat.","APTR","K/Z $","K/Z %","TÃ¼r"].map(h=><th key={h} style={{textAlign:"left",padding:"8px",color:P.ash,fontSize:10,fontWeight:600,borderBottom:`1px solid ${P.border}`,position:"sticky",top:0,background:P.card}}>{h}</th>)}</tr></thead><tbody>{res.trades.map((t,i)=>(<tr key={i} style={{borderBottom:`1px solid ${P.border}`}}><td style={{padding:"6px 8px",color:P.ash}}>{i+1}</td><td style={{padding:"6px 8px",fontSize:10}}>{new Date(t.time*1000).toLocaleDateString("tr-TR",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}</td><td style={{padding:"6px 8px"}}>${t.ae}</td><td style={{padding:"6px 8px"}}>${t.ex}</td><td style={{padding:"6px 8px",color:P.violet,fontWeight:600}}>{t.ly}</td><td style={{padding:"6px 8px",color:P.ash}}>{t.at}</td><td style={{padding:"6px 8px",color:t.pnl>=0?P.jade:P.danger,fontWeight:600}}>{t.pnl>=0?"+":""}{t.pnl.toFixed(2)}</td><td style={{padding:"6px 8px",color:t.pp>=0?P.jade:P.danger}}>{t.pp>=0?"+":""}{t.pp}%</td><td style={{padding:"6px 8px"}}><span style={{background:t.rs==="TP"?P.jade+"18":P.ember+"18",color:t.rs==="TP"?P.jade:P.ember,padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:600}}>{t.rs==="TP"?"KÃ¢r":"RSI"}</span></td></tr>))}{!res.trades.length&&<tr><td colSpan={9} style={{padding:24,textAlign:"center",color:P.ash}}>Ä°ÅŸlem yok</td></tr>}</tbody></table></div>)}
            </div>
            <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,padding:16}}><div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:12,fontWeight:600}}>Risk Analizi</div><div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8,fontFamily:Fm,fontSize:12}}><div><span style={{color:P.ash}}>En Ä°yi </span><span style={{color:P.jade,fontWeight:600}}>+${s.best}</span></div><div><span style={{color:P.ash}}>En KÃ¶tÃ¼ </span><span style={{color:s.worst<0?P.danger:P.mist,fontWeight:600}}>${s.worst}</span></div><div><span style={{color:P.ash}}>Ort. KazanÃ§ </span><span style={{color:P.jade}}>+${s.aW}</span></div><div><span style={{color:P.ash}}>Ort. KayÄ±p </span><span style={{color:P.danger}}>${s.aL}</span></div><div><span style={{color:P.ash}}>R:R </span><span style={{fontWeight:700,color:P.white}}>{s.aL!==0?Math.abs(s.aW/s.aL).toFixed(2):"âˆ"}</span></div><div><span style={{color:P.ash}}>Mod </span><span style={{color:P.white}}>{man?`Manuel ($${mA}/$${mP})`:`ATR(${aL})/${pD}`}</span></div><div style={{gridColumn:"span 2"}}><span style={{color:P.ash}}>SonuÃ§ </span><span style={{fontWeight:700,fontSize:13,color:s.ret>0&&s.mDD<25&&s.pf>1.2?P.jade:s.ret>0?P.ember:P.danger}}>{s.ret>0&&s.mDD<25&&s.pf>1.2?"âœ… Uygulanabilir":s.ret>0?"âš ï¸ Riskli":s.cnt===0?"â€”":"âŒ KÃ¢rsÄ±z"}</span></div></div></div>
            <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,padding:"12px 0 4px"}}><img src={LOGO} width="16" height="16" style={{borderRadius:3}}/><span style={{fontFamily:Fs,fontSize:11,color:P.ash}}>Built by <span style={{color:P.white,fontWeight:600}}>BottomUP</span></span></div>
          </>)}
          {st==="idle"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:10}}><img src={LOGO} width="48" height="48" style={{borderRadius:12}}/><span style={{fontFamily:Fd,fontSize:22,color:P.white}}>Press <span style={{color:P.violet}}>RUN</span> to start</span><span style={{fontFamily:Fs,fontSize:12,color:P.ash}}>Coin ve zaman dilimini seÃ§in</span></div>}
        </div>
      </div>
    </div>
  );
}
ReactDOM.render(React.createElement(App),document.getElementById('root'));
</script>
</body>
</html>
