<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Martingale V2 Backtest ‚Äî BottomUP</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>üìä</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body,#root{height:100%;width:100%;overflow:hidden}
body{background:#13151C;color:#F3F4F6;font-family:'DM Sans',system-ui,sans-serif}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#13151C}::-webkit-scrollbar-thumb{background:#2A2D3A;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#7B5CF5}
input[type=range]{-webkit-appearance:none;background:rgba(123,92,245,0.15);border-radius:3px;outline:none;height:4px;width:100%;transition:0.2s}
input[type=range]:hover{background:rgba(123,92,245,0.25)}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#7B5CF5;cursor:pointer;box-shadow:0 0 8px rgba(123,92,245,0.4)}
select{background:#1A1D26;color:#F3F4F6;border:1px solid rgba(123,92,245,0.2);border-radius:8px;padding:7px 10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;outline:none;cursor:pointer;transition:0.2s}
select:hover{border-color:rgba(123,92,245,0.4)}select:focus{border-color:#7B5CF5;box-shadow:0 0 0 2px rgba(123,92,245,0.15)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.tab-btn{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;padding:7px 16px;border-radius:8px;border:1px solid rgba(123,92,245,0.12);cursor:pointer;transition:all 0.2s;background:transparent;color:#6B7280}
.tab-btn:hover{border-color:rgba(123,92,245,0.3)}
.tab-btn.active{background:rgba(123,92,245,0.1);border-color:rgba(123,92,245,0.4);color:#7B5CF5}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useCallback,useRef}=React;
const LWC=window.LightweightCharts||window.lightweightCharts;

const P={
  violet:"#7B5CF5",ember:"#F97316",jade:"#2DC771",danger:"#EF4444",
  cobalt:"#3B5BF5",ink:"#13151C",ash:"#6B7280",mist:"#F3F4F6",white:"#FFFFFF",
  card:"#1A1D26",surface:"#1E2130",border:"rgba(123,92,245,0.12)",
};
const Fd="'Cormorant Display',Georgia,serif";
const Fs="'DM Sans',system-ui,sans-serif";
const Fm="'JetBrains Mono',monospace";

const SYMS=["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","XRPUSDT","DOGEUSDT","ADAUSDT","AVAXUSDT","DOTUSDT","LINKUSDT","MATICUSDT","UNIUSDT","ATOMUSDT","NEARUSDT","LTCUSDT","APTUSDT","ARBUSDT","OPUSDT","SUIUSDT","SEIUSDT","INJUSDT","TIAUSDT","TONUSDT","PEPEUSDT","WIFUSDT","TRXUSDT"];
const TFS=[{l:"15m",v:"15m",n:500},{l:"1h",v:"1h",n:500},{l:"4h",v:"4h",n:500},{l:"1d",v:"1d",n:365},{l:"1w",v:"1w",n:200}];

// ‚îÄ‚îÄ Binance REST ‚îÄ‚îÄ
async function fetchK(sym,intv,lim){
  const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${intv}&limit=${lim}`);
  if(!r.ok)throw new Error(`Binance API ${r.status}`);
  return(await r.json()).map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));
}

// ‚îÄ‚îÄ Indicators ‚îÄ‚îÄ
function _atr(b,x,len){if(x<1)return b[0].high-b[0].low;let s=0,n=0;for(let i=Math.max(1,x-len+1);i<=x;i++){s+=Math.max(b[i].high-b[i].low,Math.abs(b[i].high-b[i-1].close),Math.abs(b[i].low-b[i-1].close));n++;}return n?s/n:0;}
function _ema(b,x,len){const k=2/(len+1);let e=b[0].close;for(let i=1;i<=x;i++)e=b[i].close*k+e*(1-k);return e;}
function _rsi(b,x,len=14){if(x<len)return 50;let g=0,lo=0;for(let i=x-len+1;i<=x;i++){const d=b[i].close-b[i-1].close;if(d>0)g+=d;else lo-=d;}return lo===0?100:100-100/(1+g/lo);}

// ‚îÄ‚îÄ Backtest Engine ‚îÄ‚îÄ
function backtest(bars,cfg){
  const{al,man,mA,mP,aL,pD,rOn,rV,eOn}=cfg;const I=10000;
  let cash=I,pos=[],trades=[],eqData=[];let peak=I,mDD=0;
  // entries: [{time,price,layer}], exits: [{time,price,reason}]
  let entries=[],exits=[];

  for(let i=1;i<bars.length;i++){
    const p=bars[i].close,a=_atr(bars,i,aL),e10=_ema(bars,i,10),r=_rsi(bars,i);
    const fA=man?mA:a,fT=man?mP:a/pD,eS=eOn?p<e10:true,rO=rOn?r<rV:true;
    const pV=pos.reduce((s,x)=>s+x.q*p,0),curE=cash+pV;

    // ENTRY
    if(!pos.length&&eS&&rO){
      const amt=curE*(al[0]/100);
      if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:1});}
    } else if(pos.length>0&&pos.length<5){
      const lE=pos[pos.length-1].ep;
      if(p<lE-fA&&eS){
        const e2=cash+pos.reduce((s,x)=>s+x.q*p,0),amt=e2*(al[pos.length]/100);
        if(amt>1&&cash>=amt){pos.push({q:amt/p,ep:p});cash-=amt;entries.push({time:bars[i].time,price:p,layer:pos.length});}
      }
    }

    // EXIT
    if(pos.length>0){
      const tQ=pos.reduce((s,x)=>s+x.q,0),tC=pos.reduce((s,x)=>s+x.q*x.ep,0),aP=tC/tQ,rE=rOn&&r>rV;
      if(p>=aP+fT||rE){
        const eV=tQ*p,pnl=eV-tC;
        trades.push({bar:i,time:bars[i].time,ae:+aP.toFixed(2),ex:+p.toFixed(2),ly:pos.length,pnl:+pnl.toFixed(2),pp:+((pnl/tC)*100).toFixed(2),rs:rE?"RSI":"TP",at:+fA.toFixed(2)});
        exits.push({time:bars[i].time,price:p,reason:rE?"RSI":"TP",pnl:+pnl.toFixed(2)});
        cash+=eV;pos=[];
      }
    }

    const cE=cash+pos.reduce((s,x)=>s+x.q*p,0);
    if(cE>peak)peak=cE;const dd=((peak-cE)/peak)*100;if(dd>mDD)mDD=dd;
    eqData.push({time:bars[i].time,value:+cE.toFixed(2)});
  }

  const fE=cash+pos.reduce((s,x)=>s+x.q*bars[bars.length-1].close,0);
  const w=trades.filter(t=>t.pnl>0),lo=trades.filter(t=>t.pnl<=0);
  const gW=w.reduce((s,t)=>s+t.pnl,0),gL=Math.abs(lo.reduce((s,t)=>s+t.pnl,0));

  return{trades,eqData,entries,exits,s:{
    fE:+fE.toFixed(2),ret:+(((fE-I)/I)*100).toFixed(2),cnt:trades.length,
    wr:trades.length?+((w.length/trades.length)*100).toFixed(1):0,
    mDD:+mDD.toFixed(2),pf:gL>0?+(gW/gL).toFixed(2):w.length?999:0,
    aW:w.length?+(gW/w.length).toFixed(2):0,aL:lo.length?+(-gL/lo.length).toFixed(2):0,
    aLy:trades.length?+(trades.reduce((s,t)=>s+t.ly,0)/trades.length).toFixed(1):0,
    oL:pos.length,best:trades.length?+Math.max(...trades.map(t=>t.pnl)).toFixed(2):0,
    worst:trades.length?+Math.min(...trades.map(t=>t.pnl)).toFixed(2):0,
  }};
}

// ‚îÄ‚îÄ TradingView Chart Component ‚îÄ‚îÄ
function TVChart({bars,entries,exits,eqData,tab}){
  const containerRef=useRef(null);
  const chartRef=useRef(null);

  useEffect(()=>{
    if(!containerRef.current||!LWC)return;
    // Cleanup previous chart
    if(chartRef.current){try{chartRef.current.remove();}catch{}}
    containerRef.current.innerHTML='';

    const chart=LWC.createChart(containerRef.current,{
      width:containerRef.current.clientWidth,
      height:380,
      layout:{background:{type:'solid',color:P.card},textColor:P.ash,fontFamily:Fm,fontSize:11},
      grid:{vertLines:{color:'rgba(123,92,245,0.06)'},horzLines:{color:'rgba(123,92,245,0.06)'}},
      crosshair:{mode:0,vertLine:{color:P.violet+'44',width:1,style:2,labelBackgroundColor:P.violet},horzLine:{color:P.violet+'44',width:1,style:2,labelBackgroundColor:P.violet}},
      rightPriceScale:{borderColor:P.border,scaleMargins:{top:0.1,bottom:0.1}},
      timeScale:{borderColor:P.border,timeVisible:true,secondsVisible:false},
      handleScroll:true,handleScale:true,
    });
    chartRef.current=chart;

    if(tab==="candles"&&bars?.length){
      // Candlestick series
      const candleSeries=chart.addCandlestickSeries({
        upColor:P.jade,downColor:P.danger,borderUpColor:P.jade,borderDownColor:P.danger,
        wickUpColor:P.jade+'99',wickDownColor:P.danger+'99',
      });
      candleSeries.setData(bars);

      // Volume
      const volSeries=chart.addHistogramSeries({
        priceFormat:{type:'volume'},priceScaleId:'vol',
        color:P.violet+'22',
      });
      chart.priceScale('vol').applyOptions({scaleMargins:{top:0.85,bottom:0}});
      volSeries.setData(bars.map(b=>({time:b.time,value:b.volume,color:b.close>=b.open?P.jade+'33':P.danger+'33'})));

      // Buy markers (entries)
      if(entries?.length){
        const buyMarkers=entries.map(e=>({
          time:e.time,position:'belowBar',color:P.jade,
          shape:'arrowUp',text:`B${e.layer} $${e.price.toFixed(2)}`
        }));
        candleSeries.setMarkers(buyMarkers.concat(
          (exits||[]).map(x=>({
            time:x.time,position:'aboveBar',
            color:x.pnl>=0?P.jade:P.danger,
            shape:'arrowDown',
            text:`${x.reason} ${x.pnl>=0?'+':''}$${x.pnl.toFixed(0)}`
          }))
        ).sort((a,b)=>a.time-b.time));
      }
    }

    if(tab==="equity"&&eqData?.length){
      const eqSeries=chart.addAreaSeries({
        topColor:P.violet+'33',bottomColor:P.violet+'05',
        lineColor:P.violet,lineWidth:2,
        priceFormat:{type:'custom',formatter:v=>'$'+v.toFixed(0)},
      });
      eqSeries.setData(eqData);

      // $10k reference line
      const refSeries=chart.addLineSeries({
        color:P.ash+'44',lineWidth:1,lineStyle:2,
        priceFormat:{type:'custom',formatter:()=>'$10k'},
      });
      refSeries.setData(eqData.map(d=>({time:d.time,value:10000})));
    }

    if(tab==="drawdown"&&eqData?.length){
      // Calculate drawdown series from equity
      let peak=10000;
      const ddData=eqData.map(d=>{
        if(d.value>peak)peak=d.value;
        return{time:d.time,value:+((peak-d.value)/peak*100).toFixed(2)};
      });
      const ddSeries=chart.addAreaSeries({
        topColor:P.danger+'33',bottomColor:P.danger+'05',
        lineColor:P.danger,lineWidth:2,invertFilledArea:true,
        priceFormat:{type:'custom',formatter:v=>v.toFixed(1)+'%'},
      });
      ddSeries.setData(ddData);
    }

    chart.timeScale().fitContent();

    const ro=new ResizeObserver(()=>{
      if(containerRef.current)chart.applyOptions({width:containerRef.current.clientWidth});
    });
    ro.observe(containerRef.current);
    return()=>{ro.disconnect();try{chart.remove();}catch{}};
  },[bars,entries,exits,eqData,tab]);

  return <div ref={containerRef} style={{width:"100%",borderRadius:12,overflow:"hidden"}}/>;
}

// ‚îÄ‚îÄ UI Components ‚îÄ‚îÄ
const Stat=({l,v,color,pre="",suf=""})=>(
  <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:12,padding:"12px 14px",flex:"1 1 120px",minWidth:105,animation:"fadeIn 0.3s",transition:"border-color 0.2s"}}
    onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(123,92,245,0.25)'}
    onMouseLeave={e=>e.currentTarget.style.borderColor=P.border}>
    <div style={{fontFamily:Fm,fontSize:9,color:P.ash,letterSpacing:"0.1em",textTransform:"uppercase",marginBottom:6}}>{l}</div>
    <div style={{fontFamily:Fm,fontSize:16,fontWeight:600,color:color||P.mist}}>{pre}{typeof v==="number"?v.toLocaleString("en",{maximumFractionDigits:2}):v}{suf}</div>
  </div>
);
const Sld=({l,v,set,min,max,step=1,suf=""})=>(
  <div style={{marginBottom:10}}>
    <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
      <span style={{fontFamily:Fs,fontSize:11,color:P.ash,fontWeight:500}}>{l}</span>
      <span style={{fontFamily:Fm,fontSize:11,color:P.violet,fontWeight:600}}>{v}{suf}</span>
    </div>
    <input type="range" min={min} max={max} step={step} value={v} onChange={e=>set(+e.target.value)}/>
  </div>
);
const Tog=({l,v,set})=>(
  <label style={{display:"flex",alignItems:"center",gap:8,fontFamily:Fs,fontSize:11,color:P.ash,marginBottom:8,cursor:"pointer",fontWeight:500}}>
    <div onClick={()=>set(!v)} style={{width:36,height:20,borderRadius:10,background:v?P.violet:"#2A2D3A",position:"relative",flexShrink:0,transition:"0.25s",boxShadow:v?`0 0 10px ${P.violet}33`:"none"}}>
      <div style={{width:16,height:16,borderRadius:8,background:P.white,position:"absolute",top:2,left:v?18:2,transition:"0.25s",boxShadow:"0 1px 3px rgba(0,0,0,0.3)"}}/>
    </div>{l}
  </label>
);

// ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ
function App(){
  const[sym,setSym]=useState("ETHUSDT");const[tf,setTf]=useState("1h");
  const[a1,sA1]=useState(10);const[a2,sA2]=useState(15);const[a3,sA3]=useState(20);const[a4,sA4]=useState(25);const[a5,sA5]=useState(30);
  const[man,setMan]=useState(true);const[mA,setMA]=useState(80);const[mP,setMP]=useState(40);
  const[aL,setAL]=useState(14);const[pD,setPD]=useState(2);
  const[rOn,setROn]=useState(false);const[rV,setRV]=useState(71);const[eOn,setEOn]=useState(true);
  const[res,setRes]=useState(null);const[bars,setBars]=useState(null);
  const[tab,setTab]=useState("candles");const[st,setSt]=useState("idle");
  const[lP,setLP]=useState(null);const[err,setErr]=useState(null);const ws=useRef(null);

  const sDef=useCallback((s,t)=>{
    if(!man)return;const m={"15m":0,"1h":1,"4h":2,"1d":3,"1w":4}[t]||1;
    if(s.startsWith("BTC")){setMA([200,500,1500,3000,6000][m]);setMP([100,250,750,1500,3000][m]);}
    else if(s.startsWith("ETH")){setMA([10,30,80,200,500][m]);setMP([5,15,40,100,250][m]);}
    else if(s.startsWith("BNB")){setMA([3,8,20,50,100][m]);setMP([1.5,4,10,25,50][m]);}
    else if(["SOLUSDT","AVAXUSDT","DOTUSDT","LINKUSDT","UNIUSDT","NEARUSDT","APTUSDT","INJUSDT","SUIUSDT"].includes(s)){setMA([0.5,2,5,15,30][m]);setMP([0.25,1,2.5,7,15][m]);}
    else if(["DOGEUSDT","PEPEUSDT","WIFUSDT","SEIUSDT","TRXUSDT","XRPUSDT","ADAUSDT"].includes(s)){setMA([0.002,0.005,0.015,0.04,0.1][m]);setMP([0.001,0.0025,0.007,0.02,0.05][m]);}
    else{setMA([1,3,10,25,60][m]);setMP([0.5,1.5,5,12,30][m]);}
  },[man]);

  const run=useCallback(async()=>{
    setSt("loading");setErr(null);
    try{const d=await fetchK(sym,tf,TFS.find(t=>t.v===tf).n);setBars(d);
      setRes(backtest(d,{al:[a1,a2,a3,a4,a5],man,mA,mP,aL,pD,rOn,rV,eOn}));setSt("done");
    }catch(e){setErr(e.message);setSt("error");}
  },[sym,tf,a1,a2,a3,a4,a5,man,mA,mP,aL,pD,rOn,rV,eOn]);

  useEffect(()=>{if(ws.current)ws.current.close();setLP(null);
    try{const w=new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@trade`);w.onmessage=e=>{try{setLP(+parseFloat(JSON.parse(e.data).p).toFixed(4));}catch{}};ws.current=w;}catch{}
    return()=>{if(ws.current)ws.current.close();};
  },[sym]);
  useEffect(()=>{run();},[]);

  const s=res?.s;const rc=s?(s.ret>=0?P.jade:P.danger):P.mist;const aT=a1+a2+a3+a4+a5;

  return(
    <div style={{minHeight:"100vh",background:P.ink,color:P.mist,fontFamily:Fs}}>
      {/* HEADER */}
      <div style={{padding:"12px 20px",borderBottom:`1px solid ${P.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:10,background:`linear-gradient(180deg,${P.card},${P.ink})`}}>
        <div style={{display:"flex",alignItems:"center",gap:12}}>
          <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg,${P.violet},${P.cobalt})`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:17,boxShadow:`0 4px 15px ${P.violet}33`}}>üìä</div>
          <div>
            <h1 style={{fontFamily:Fd,fontSize:22,fontWeight:700,color:P.white}}>Martingale <span style={{color:P.violet}}>V2</span></h1>
            <p style={{fontFamily:Fm,fontSize:9,color:P.ash,letterSpacing:"0.08em"}}>BINANCE ‚Ä¢ TRADINGVIEW CHARTS ‚Ä¢ PINE SCRIPT ENGINE</p>
          </div>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
          {lP&&<div style={{fontFamily:Fm,fontSize:14,color:P.jade,display:"flex",alignItems:"center",gap:5,fontWeight:600}}>
            <div style={{width:7,height:7,borderRadius:4,background:P.jade,animation:"pulse 2s infinite",boxShadow:`0 0 8px ${P.jade}66`}}/>${lP.toLocaleString("en")}
          </div>}
          <select value={sym} onChange={e=>{setSym(e.target.value);sDef(e.target.value,tf);}}>{SYMS.map(s=><option key={s} value={s}>{s.replace("USDT","/USDT")}</option>)}</select>
          <select value={tf} onChange={e=>{setTf(e.target.value);sDef(sym,e.target.value);}}>{TFS.map(t=><option key={t.v} value={t.v}>{t.l}</option>)}</select>
          <button onClick={run} disabled={st==="loading"} style={{fontFamily:Fs,fontSize:12,fontWeight:700,padding:"8px 22px",borderRadius:10,background:st==="loading"?"#2A2D3A":`linear-gradient(135deg,${P.violet},${P.cobalt})`,border:"none",color:P.white,cursor:st==="loading"?"wait":"pointer",boxShadow:st==="loading"?"none":`0 4px 20px ${P.violet}40`,transition:"0.2s",letterSpacing:"0.03em"}}>{st==="loading"?"‚è≥":"‚ñ∂  RUN"}</button>
        </div>
      </div>

      {err&&<div style={{margin:"10px 20px",padding:"10px 14px",background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:10,fontFamily:Fm,fontSize:12,color:P.danger}}>‚ö† {err}</div>}

      <div style={{display:"flex",height:"calc(100vh - 58px)"}}>
        {/* SIDEBAR */}
        <div style={{width:240,minWidth:240,borderRight:`1px solid ${P.border}`,padding:"14px 12px",overflowY:"auto",background:P.card+"88"}}>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Allocation</div>
          {[[a1,sA1,"Pos 1"],[a2,sA2,"Pos 2"],[a3,sA3,"Pos 3"],[a4,sA4,"Pos 4"],[a5,sA5,"Pos 5"]].map(([v,s,l])=><Sld key={l} l={l} v={v} set={s} min={1} max={50} suf="%"/>)}
          <div style={{fontFamily:Fm,fontSize:11,color:aT===100?P.jade:P.ember,marginBottom:4,fontWeight:600}}>Total: {aT}%{aT!==100&&" ‚ö†"}</div>

          <div style={{height:1,background:P.border,margin:"10px 0"}}/>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Strategy</div>
          <Tog l="Manual Mode" v={man} set={setMan}/>
          {man?(<>
            <Sld l="APTR (Drop $)" v={mA} set={setMA} min={0.0005} max={8000} step={mA>100?10:mA>10?1:mA>1?0.1:0.001}/>
            <Sld l="Profit Target $" v={mP} set={setMP} min={0.0005} max={4000} step={mP>50?5:mP>5?0.5:mP>0.5?0.05:0.0005}/>
          </>):(<>
            <Sld l="ATR Length" v={aL} set={setAL} min={5} max={50}/>
            <Sld l="Profit Divisor" v={pD} set={setPD} min={1} max={5} step={0.5}/>
          </>)}

          <div style={{height:1,background:P.border,margin:"10px 0"}}/>
          <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",marginBottom:8,textTransform:"uppercase",fontWeight:600}}>Filters</div>
          <Tog l="10 EMA Entry" v={eOn} set={setEOn}/>
          <Tog l="RSI Exit" v={rOn} set={setROn}/>
          {rOn&&<Sld l="RSI Level" v={rV} set={setRV} min={50} max={90}/>}

          {bars&&<div style={{marginTop:12,padding:10,background:"rgba(123,92,245,0.05)",borderRadius:10,border:`1px solid ${P.border}`,fontFamily:Fm,fontSize:10}}>
            <div style={{color:P.violet,marginBottom:4,fontWeight:600}}>üìä {sym.replace("USDT","/USDT")} ‚Ä¢ {tf}</div>
            <div style={{color:P.ash}}>{bars.length} candles loaded</div>
          </div>}
        </div>

        {/* MAIN */}
        <div style={{flex:1,padding:14,overflowY:"auto"}}>
          {st==="loading"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:12}}>
            <div style={{width:28,height:28,border:`3px solid ${P.violet}`,borderTopColor:"transparent",borderRadius:"50%",animation:"spin .7s linear infinite"}}/>
            <span style={{fontFamily:Fs,fontSize:13,color:P.ash}}>Binance'den veri √ßekiliyor...</span>
          </div>}

          {s&&st==="done"&&(<>
            {/* STATS */}
            <div style={{display:"flex",flexWrap:"wrap",gap:8,marginBottom:12}}>
              <Stat l="Final Equity" v={s.fE} pre="$" color={rc}/>
              <Stat l="Return" v={s.ret} suf="%" color={rc} pre={s.ret>=0?"+":""}/>
              <Stat l="Win Rate" v={s.wr} suf="%" color={s.wr>=50?P.jade:P.danger}/>
              <Stat l="Max DD" v={s.mDD} suf="%" color={P.danger} pre="-"/>
              <Stat l="Profit Factor" v={s.pf} color={s.pf>=1.5?P.jade:s.pf>=1?P.ember:P.danger}/>
              <Stat l="Trades" v={s.cnt} color={P.cobalt}/>
              <Stat l="Avg Layers" v={s.aLy} color={P.violet}/>
              {s.oL>0&&<Stat l="‚ö† Open" v={s.oL} suf=" layers" color={P.ember}/>}
            </div>

            {/* TABS */}
            <div style={{display:"flex",gap:4,marginBottom:10}}>
              {[["candles","üïØ Candlestick"],["equity","üìà Equity"],["drawdown","üìâ Drawdown"],["trades","üìã Trades"]].map(([k,lb])=>(
                <button key={k} className={`tab-btn${tab===k?" active":""}`} onClick={()=>setTab(k)}>{lb}</button>
              ))}
            </div>

            {/* CHART */}
            <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,overflow:"hidden",marginBottom:12}}>
              {tab!=="trades"?
                <TVChart bars={bars} entries={res.entries} exits={res.exits} eqData={res.eqData} tab={tab}/>
              :(
                <div style={{maxHeight:380,overflowY:"auto",padding:14}}>
                  <table style={{width:"100%",borderCollapse:"collapse",fontFamily:Fm,fontSize:11}}>
                    <thead><tr>{["#","Time","Avg Entry","Exit","Layers","ATR","PnL $","PnL %","Type"].map(h=><th key={h} style={{textAlign:"left",padding:"8px",color:P.ash,fontSize:10,fontWeight:600,borderBottom:`1px solid ${P.border}`,position:"sticky",top:0,background:P.card}}>{h}</th>)}</tr></thead>
                    <tbody>{res.trades.map((t,i)=>(
                      <tr key={i} style={{borderBottom:`1px solid ${P.border}`}}>
                        <td style={{padding:"6px 8px",color:P.ash}}>{i+1}</td>
                        <td style={{padding:"6px 8px"}}>{new Date(t.time*1000).toLocaleDateString("tr-TR",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}</td>
                        <td style={{padding:"6px 8px"}}>${t.ae.toLocaleString("en")}</td>
                        <td style={{padding:"6px 8px"}}>${t.ex.toLocaleString("en")}</td>
                        <td style={{padding:"6px 8px",color:P.violet,fontWeight:600}}>{t.ly}</td>
                        <td style={{padding:"6px 8px",color:P.ash}}>{t.at}</td>
                        <td style={{padding:"6px 8px",color:t.pnl>=0?P.jade:P.danger,fontWeight:600}}>{t.pnl>=0?"+":""}{t.pnl.toFixed(2)}</td>
                        <td style={{padding:"6px 8px",color:t.pp>=0?P.jade:P.danger}}>{t.pp>=0?"+":""}{t.pp}%</td>
                        <td style={{padding:"6px 8px"}}><span style={{background:t.rs==="TP"?P.jade+"18":P.ember+"18",color:t.rs==="TP"?P.jade:P.ember,padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:600}}>{t.rs}</span></td>
                      </tr>
                    ))}{!res.trades.length&&<tr><td colSpan={9} style={{padding:24,textAlign:"center",color:P.ash}}>Trade yok</td></tr>}</tbody>
                  </table>
                </div>
              )}
            </div>

            {/* RISK */}
            <div style={{background:P.card,border:`1px solid ${P.border}`,borderRadius:14,padding:16}}>
              <div style={{fontFamily:Fm,fontSize:10,color:P.violet,letterSpacing:"0.12em",textTransform:"uppercase",marginBottom:12,fontWeight:600}}>Risk Analysis</div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8,fontFamily:Fm,fontSize:12}}>
                <div><span style={{color:P.ash}}>Best </span><span style={{color:P.jade,fontWeight:600}}>+${s.best}</span></div>
                <div><span style={{color:P.ash}}>Worst </span><span style={{color:s.worst<0?P.danger:P.mist,fontWeight:600}}>${s.worst}</span></div>
                <div><span style={{color:P.ash}}>Avg Win </span><span style={{color:P.jade}}>+${s.aW}</span></div>
                <div><span style={{color:P.ash}}>Avg Loss </span><span style={{color:P.danger}}>${s.aL}</span></div>
                <div><span style={{color:P.ash}}>R:R </span><span style={{fontWeight:700,color:P.white}}>{s.aL!==0?Math.abs(s.aW/s.aL).toFixed(2):"‚àû"}</span></div>
                <div><span style={{color:P.ash}}>Mode </span><span style={{color:P.white}}>{man?`Manual ($${mA}/$${mP})`:`ATR(${aL})/${pD}`}</span></div>
                <div style={{gridColumn:"span 2"}}><span style={{color:P.ash}}>Verdict </span><span style={{fontWeight:700,fontSize:13,color:s.ret>0&&s.mDD<25&&s.pf>1.2?P.jade:s.ret>0?P.ember:P.danger}}>{s.ret>0&&s.mDD<25&&s.pf>1.2?"‚úÖ Viable Strategy":s.ret>0?"‚ö†Ô∏è Risky":s.cnt===0?"‚Äî No Trades":"‚ùå Unprofitable"}</span></div>
              </div>
            </div>
            <div style={{textAlign:"center",padding:"14px 0 6px",fontFamily:Fs,fontSize:11,color:P.ash}}>Built with <span style={{color:P.violet}}>‚ô•</span> by <span style={{color:P.violet,fontWeight:600}}>BottomUP</span></div>
          </>)}
          {st==="idle"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:300,gap:8}}>
            <div style={{fontSize:36}}>üìä</div>
            <span style={{fontFamily:Fd,fontSize:22,color:P.white}}>Press <span style={{color:P.violet}}>RUN</span> to start</span>
            <span style={{fontFamily:Fs,fontSize:12,color:P.ash}}>Select a pair and timeframe</span>
          </div>}
        </div>
      </div>
    </div>
  );
}
ReactDOM.render(React.createElement(App),document.getElementById('root'));
</script>
</body>
</html>
